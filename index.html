<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SPSV2 ‚Äî Personal na Palma da Sua M√£o</title>
  <meta name="theme-color" content="#0b0f14" />

  <style>
    :root{
      --bg:#0b0f14;
      --panel:#0f1622;
      --card:rgba(255,255,255,.06);
      --card2:rgba(255,255,255,.04);
      --line:rgba(255,255,255,.10);
      --text:#eaf2fb;
      --muted:#9aa7b5;
      --ok:#2ee59d;
      --warn:#ffc66e;
      --bad:#ff5c77;
      --aqua:#64c8ff;
      --shadow:0 18px 60px rgba(0,0,0,.45);
      --r:18px;

      --btn:rgba(100,200,255,.12);
      --btn2:rgba(46,229,157,.12);
      --btn3:rgba(255,92,119,.12);
      --focus:rgba(100,200,255,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial;
      color:var(--text);
      background:
        radial-gradient(900px 520px at 15% 12%, rgba(100,200,255,.16), transparent 60%),
        radial-gradient(900px 520px at 85% 30%, rgba(46,229,157,.12), transparent 60%),
        radial-gradient(900px 520px at 55% 90%, rgba(255,198,110,.10), transparent 60%),
        var(--bg);
    }

    /* Layout */
    .app{min-height:100%; display:flex; gap:14px; padding:16px}
    .sidebar{
      width:280px; min-width:260px;
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius:20px;
      padding:14px;
      box-shadow:var(--shadow);
      backdrop-filter: blur(10px);
      position:sticky; top:16px; height:calc(100vh - 32px);
      display:flex; flex-direction:column; gap:12px;
    }
    .main{
      flex:1;
      display:flex;
      flex-direction:column;
      gap:14px;
      min-width: 320px;
    }
    .topbar{
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius:20px;
      padding:14px;
      box-shadow:var(--shadow);
      backdrop-filter: blur(10px);
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .content{
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius:20px;
      padding:14px;
      box-shadow:var(--shadow);
      backdrop-filter: blur(10px);
      min-height: calc(100vh - 32px - 84px);
    }

    /* Sidebar */
    .brand{display:flex; align-items:center; gap:10px}
    .logo{
      width:40px;height:40px;border-radius:14px;
      background:linear-gradient(135deg, rgba(100,200,255,.35), rgba(46,229,157,.25));
      border:1px solid var(--line);
      box-shadow:0 10px 30px rgba(0,0,0,.30);
    }
    .brand h1{margin:0; font-size:14px; letter-spacing:.5px}
    .brand .sub{margin:0; color:var(--muted); font-size:12px}
    .badge{
      margin-left:auto;
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px;
      border:1px solid var(--line);
      border-radius:999px;
      background:rgba(0,0,0,.18);
      color:var(--muted);
      font-size:12px;
      white-space:nowrap;
    }
    .dot{width:9px;height:9px;border-radius:9px;background:var(--warn); box-shadow:0 0 0 4px rgba(255,198,110,.12)}
    .dot.ok{background:var(--ok); box-shadow:0 0 0 4px rgba(46,229,157,.12)}
    .dot.bad{background:var(--bad); box-shadow:0 0 0 4px rgba(255,92,119,.12)}

    .nav{display:flex; flex-direction:column; gap:6px; margin-top:6px}
    .nav button{
      width:100%;
      text-align:left;
      border:1px solid transparent;
      background:transparent;
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .nav button:hover{background:rgba(255,255,255,.05)}
    .nav button.active{
      background:rgba(100,200,255,.10);
      border-color:rgba(100,200,255,.22);
    }
    .nav small{color:var(--muted)}
    .sidebar .foot{
      margin-top:auto;
      border-top:1px solid var(--line);
      padding-top:12px;
      display:flex; flex-direction:column; gap:10px;
      color:var(--muted);
      font-size:12px;
    }
    .miniRow{display:flex; gap:8px; align-items:center; justify-content:space-between}
    .pill{
      display:inline-flex; gap:8px; align-items:center;
      border:1px solid var(--line);
      background:rgba(0,0,0,.16);
      padding:8px 10px;
      border-radius:999px;
      font-size:12px;
      color:var(--muted);
    }

    /* UI atoms */
    .grid{display:grid; grid-template-columns:1.35fr .95fr; gap:14px}
    @media (max-width: 1100px){
      .sidebar{display:none}
      .grid{grid-template-columns:1fr}
      .content{min-height:auto}
      .app{padding:10px}
    }

    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius:var(--r);
      padding:14px;
      box-shadow:0 10px 30px rgba(0,0,0,.25);
    }
    .card h2{margin:0 0 6px 0; font-size:16px}
    .card p{margin:0 0 10px 0; color:var(--muted); font-size:13px}

    label{display:block; color:var(--muted); font-size:12px; margin:10px 0 6px}
    input, select, textarea{
      width:100%;
      padding:11px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.18);
      color:var(--text);
      outline:none;
    }
    textarea{min-height:90px; resize:vertical}
    input:focus, select:focus, textarea:focus{border-color:var(--focus); box-shadow:0 0 0 4px rgba(100,200,255,.10)}
    .row{display:flex; gap:10px; flex-wrap:wrap}
    .row > *{flex:1}
    .actions{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px}
    .btn{
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px 12px;
      background:var(--btn);
      color:var(--text);
      cursor:pointer;
      font-weight:650;
    }
    .btn:hover{filter:brightness(1.05)}
    .btn.ok{background:var(--btn2)}
    .btn.bad{background:var(--btn3)}
    .btn.ghost{background:transparent}
    .btn.small{padding:8px 10px; border-radius:12px; font-weight:600; font-size:12px}
    .status{
      margin-top:12px;
      border:1px solid rgba(255,198,110,.25);
      background:rgba(255,198,110,.08);
      padding:10px 12px;
      border-radius:14px;
      color:var(--warn);
      font-size:13px;
    }
    .status.ok{border-color:rgba(46,229,157,.25); background:rgba(46,229,157,.08); color:var(--ok)}
    .status.bad{border-color:rgba(255,92,119,.25); background:rgba(255,92,119,.08); color:var(--bad)}
    .muted{color:var(--muted)}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace}
    .hr{height:1px;background:var(--line); margin:12px 0}

    /* Tables */
    table{width:100%; border-collapse:collapse; overflow:hidden; border-radius:14px}
    th, td{padding:10px 10px; border-bottom:1px solid rgba(255,255,255,.08); vertical-align:top}
    th{color:var(--muted); font-size:12px; text-transform:uppercase; letter-spacing:.06em; text-align:left}
    tr:hover td{background:rgba(255,255,255,.03)}
    .tdActions{white-space:nowrap}
    .tag{
      display:inline-flex; align-items:center; gap:6px;
      padding:5px 9px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.16);
      color:var(--muted);
      font-size:12px;
    }
    .tag.ok{border-color:rgba(46,229,157,.25); color:var(--ok); background:rgba(46,229,157,.08)}
    .tag.warn{border-color:rgba(255,198,110,.25); color:var(--warn); background:rgba(255,198,110,.08)}
    .tag.bad{border-color:rgba(255,92,119,.25); color:var(--bad); background:rgba(255,92,119,.08)}
    .right{display:flex; align-items:center; gap:10px; justify-content:flex-end}

    /* Modal */
    .modalBackdrop{
      position:fixed; inset:0;
      background:rgba(0,0,0,.60);
      display:none;
      align-items:center; justify-content:center;
      padding:16px;
      z-index:9999;
    }
    .modal{
      width:min(860px, 100%);
      background:linear-gradient(180deg, rgba(15,22,34,.96), rgba(10,14,20,.92));
      border:1px solid var(--line);
      border-radius:22px;
      box-shadow:var(--shadow);
      padding:14px;
    }
    .modalHead{display:flex; align-items:center; justify-content:space-between; gap:10px}
    .modalHead h3{margin:0; font-size:16px}
    .close{background:transparent; border:1px solid var(--line); color:var(--text); border-radius:12px; padding:8px 10px; cursor:pointer}
    .modalBody{margin-top:10px}
    .footer{
      margin-top:12px;
      text-align:center;
      color:var(--muted);
      font-size:12px;
      padding:10px 0 4px;
    }
  </style>
</head>

<body>
  <div class="app">
    <aside class="sidebar">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>SPSV2</h1>
          <p class="sub">Personal na Palma da Sua M√£o</p>
        </div>
        <div class="badge" title="Status do Supabase e sess√£o">
          <span id="dot" class="dot"></span>
          <span id="badgeText">Desconectado</span>
        </div>
      </div>

      <div class="nav" id="nav">
        <button data-view="dashboard" class="active"><span>üè† Dashboard</span><small>Vis√£o geral</small></button>
        <button data-view="alunos"><span>üë• Alunos</span><small>Cadastro e hist√≥rico</small></button>
        <button data-view="sessoes"><span>üóìÔ∏è Sess√µes</span><small>Treinos e controle</small></button>
        <button data-view="exercicios"><span>üèãÔ∏è Exerc√≠cios</span><small>Biblioteca</small></button>
        <button data-view="relatorios"><span>üìÑ Relat√≥rios</span><small>Export/prints</small></button>
        <button data-view="admin"><span>üõ°Ô∏è Admin</span><small>Configura√ß√µes</small></button>
      </div>

      <div class="foot">
        <div class="miniRow">
          <span class="pill" title="Projeto Supabase">
            ‚úÖ <span class="mono" id="sbHost">supabase</span>
          </span>
          <button class="btn small ghost" id="btnOpenConfig">Config</button>
        </div>
        <div class="miniRow">
          <span class="muted">Sess√£o:</span>
          <span class="mono" id="uidShort">‚Äî</span>
        </div>
      </div>
    </aside>

    <main class="main">
      <div class="topbar">
        <div>
          <div style="font-weight:750; letter-spacing:.2px">SPSV2 ‚Äî Painel Completo</div>
          <div class="muted" style="font-size:12px; margin-top:2px" id="subtitle">
            Alunos ‚Ä¢ Sess√µes ‚Ä¢ Exerc√≠cios ‚Ä¢ Relat√≥rios ‚Ä¢ Admin
          </div>
        </div>

        <div class="right">
          <span class="tag" id="tagEnv">GitHub Pages</span>
          <button class="btn ghost" id="btnQuickHelp">Ajuda</button>
          <button class="btn" id="btnLogout" disabled>Sair</button>
        </div>
      </div>

      <div class="content">
        <div id="viewRoot"></div>
        <div class="footer">Editora Samurai ‚Äî CNPJ 51.041.045/0001-45 ‚Äî Todos os direitos reservados.</div>
      </div>
    </main>
  </div>

  <!-- Modal: Config -->
  <div class="modalBackdrop" id="configModal">
    <div class="modal">
      <div class="modalHead">
        <h3>Configura√ß√£o (Supabase)</h3>
        <button class="close" data-close="configModal">Fechar</button>
      </div>
      <div class="modalBody">
        <p class="muted" style="margin:0 0 10px 0">
          Cole aqui a URL do seu projeto e a <b>Anon Key</b>. Isso fica salvo no seu navegador (localStorage).
        </p>
        <div class="row">
          <div>
            <label>SUPABASE_URL</label>
            <input id="cfgUrl" placeholder="https://xxxxx.supabase.co" />
          </div>
          <div>
            <label>SUPABASE_ANON_KEY</label>
            <input id="cfgKey" placeholder="eyJhbGciOi..." />
          </div>
        </div>
        <div class="actions">
          <button class="btn ok" id="btnSaveConfig">Salvar</button>
          <button class="btn" id="btnTestConn">Testar conex√£o</button>
          <button class="btn bad" id="btnClearConfig">Limpar</button>
        </div>
        <div id="cfgStatus" class="status">Cole sua URL e Anon Key para habilitar o app.</div>

        <div class="hr"></div>
        <details>
          <summary style="cursor:pointer; color:var(--muted)">Regras recomendadas (banco) ‚Äî leitura r√°pida</summary>
          <div style="margin-top:10px; color:var(--muted); font-size:13px; line-height:1.5">
            <div><b>Ideia padr√£o:</b> todas as tabelas principais t√™m a coluna <span class="mono">user_id uuid</span> (dono).</div>
            <div>RLS: permitir <span class="mono">SELECT/INSERT/UPDATE/DELETE</span> apenas quando <span class="mono">user_id = auth.uid()</span>.</div>
            <div>Para <span class="mono">profiles</span>, usar <span class="mono">id = auth.uid()</span> (como voc√™ j√° fez).</div>
          </div>
        </details>
      </div>
    </div>
  </div>

  <!-- Modal: Ajuda -->
  <div class="modalBackdrop" id="helpModal">
    <div class="modal">
      <div class="modalHead">
        <h3>Ajuda r√°pida</h3>
        <button class="close" data-close="helpModal">Fechar</button>
      </div>
      <div class="modalBody" style="color:var(--muted); font-size:13px; line-height:1.55">
        <p style="margin-top:0">
          <b>1)</b> Abra <span class="mono">Config</span> e cole <b>SUPABASE_URL</b> + <b>ANON_KEY</b>.<br>
          <b>2)</b> Fa√ßa login (email/senha).<br>
          <b>3)</b> Cadastre alunos ‚Üí crie sess√µes ‚Üí adicione itens/execu√ß√£o ‚Üí gere relat√≥rios.
        </p>
        <p>
          Se alguma tela der ‚Äúsem permiss√£o‚Äù, √© RLS. Confirme se as tabelas t√™m <span class="mono">user_id</span> e as pol√≠ticas est√£o corretas.
        </p>
      </div>
    </div>
  </div>

  <script>
    /*****************************************************************
     * SPSV2 ‚Äî App Completo (Single-file) ‚Äî GitHub Pages + Supabase
     * - Login/Logout (email/senha)
     * - Perfil (profiles)
     * - CRUD: students, sessions, session_items, exercises
     * - Relat√≥rios: export CSV simples
     * - Admin: seeds e testes
     *****************************************************************/

    /* ===============================================================
       0) Config (URL/ANON) ‚Äî salva no navegador
    =============================================================== */
    const LS = {
      url: "SPSV2_SUPABASE_URL",
      key: "SPSV2_SUPABASE_ANON",
      lastView: "SPSV2_LAST_VIEW",
    };

    const state = {
      sbUrl: localStorage.getItem(LS.url) || "",
      sbKey: localStorage.getItem(LS.key) || "",
      session: null,      // { access_token, user: { id, email } }
      profile: null,      // row from profiles
      view: localStorage.getItem(LS.lastView) || "dashboard",
      cache: {
        students: [],
        sessions: [],
        exercises: [],
      },
      loading: false,
    };

    /* ===============================================================
       1) Utilidades
    =============================================================== */
    const $ = (sel) => document.querySelector(sel);
    const el = (tag, attrs={}, children=[]) => {
      const n = document.createElement(tag);
      for (const [k,v] of Object.entries(attrs)){
        if (k === "class") n.className = v;
        else if (k === "html") n.innerHTML = v;
        else if (k.startsWith("on") && typeof v === "function") n.addEventListener(k.slice(2), v);
        else n.setAttribute(k, v);
      }
      (children||[]).forEach(c => n.appendChild(typeof c === "string" ? document.createTextNode(c) : c));
      return n;
    };

    const safeJson = async (res) => {
      const txt = await res.text();
      try { return JSON.parse(txt); } catch { return { _raw: txt }; }
    };

    const fmtDate = (iso) => {
      if (!iso) return "‚Äî";
      const d = new Date(iso);
      if (Number.isNaN(d.getTime())) return iso;
      return d.toLocaleString("pt-BR");
    };

    const uidShort = (uid) => uid ? (uid.slice(0,8)+"‚Ä¶"+uid.slice(-4)) : "‚Äî";

    const setBadge = (mode, text) => {
      const dot = $("#dot");
      const badgeText = $("#badgeText");
      dot.classList.remove("ok","bad");
      if (mode === "ok") dot.classList.add("ok");
      if (mode === "bad") dot.classList.add("bad");
      badgeText.textContent = text;
    };

    const setEnvTag = () => {
      const isGh = location.host.includes("github.io");
      $("#tagEnv").textContent = isGh ? "GitHub Pages" : "Web";
      $("#sbHost").textContent = state.sbUrl ? (new URL(state.sbUrl).host) : "supabase";
    };

    const setView = (view) => {
      state.view = view;
      localStorage.setItem(LS.lastView, view);
      // nav highlight
      document.querySelectorAll("#nav button").forEach(b => b.classList.toggle("active", b.dataset.view === view));
      render();
    };

    const openModal = (id) => { $("#"+id).style.display = "flex"; };
    const closeModal = (id) => { $("#"+id).style.display = "none"; };

    document.addEventListener("click", (e) => {
      const btn = e.target.closest("[data-close]");
      if (btn) closeModal(btn.getAttribute("data-close"));
      const navBtn = e.target.closest("#nav button[data-view]");
      if (navBtn) setView(navBtn.dataset.view);
    });

    $("#btnOpenConfig").addEventListener("click", () => {
      $("#cfgUrl").value = state.sbUrl || "";
      $("#cfgKey").value = state.sbKey || "";
      cfgStatus("Cole a URL e Anon Key e clique em Salvar.", "warn");
      openModal("configModal");
    });

    $("#btnQuickHelp").addEventListener("click", () => openModal("helpModal"));

    function cfgStatus(msg, type="warn"){
      const box = $("#cfgStatus");
      box.className = "status";
      if (type === "ok") box.classList.add("ok");
      if (type === "bad") box.classList.add("bad");
      box.textContent = msg;
    }

    $("#btnSaveConfig").addEventListener("click", () => {
      const url = $("#cfgUrl").value.trim();
      const key = $("#cfgKey").value.trim();
      if (!url || !key){
        cfgStatus("Faltou preencher URL e/ou ANON_KEY.", "bad");
        return;
      }
      state.sbUrl = url;
      state.sbKey = key;
      localStorage.setItem(LS.url, url);
      localStorage.setItem(LS.key, key);
      setEnvTag();
      cfgStatus("Config salvo. Agora clique em Testar conex√£o e depois feche.", "ok");
    });

    $("#btnClearConfig").addEventListener("click", () => {
      localStorage.removeItem(LS.url);
      localStorage.removeItem(LS.key);
      state.sbUrl = "";
      state.sbKey = "";
      state.session = null;
      state.profile = null;
      setEnvTag();
      setBadge("warn","Desconectado");
      $("#btnLogout").disabled = true;
      cfgStatus("Config limpo. Cole novamente para usar o app.", "warn");
      render();
    });

    $("#btnTestConn").addEventListener("click", async () => {
      if (!state.sbUrl || !state.sbKey){
        cfgStatus("Sem URL/ANON_KEY. Salve primeiro.", "bad");
        return;
      }
      cfgStatus("Testando conex√£o‚Ä¶", "warn");
      try{
        // endpoint p√∫blico que existe em todo projeto: /rest/v1/ (vai responder 401/406 dependendo) ‚Äî vamos s√≥ testar reachability
        const res = await fetch(state.sbUrl + "/rest/v1/", {
          headers: { apikey: state.sbKey, Authorization: "Bearer " + state.sbKey }
        });
        // mesmo que d√™ 404/406, se respondeu √© reachability
        cfgStatus("Conex√£o OK (servidor respondeu).", "ok");
      }catch(err){
        cfgStatus("Falha ao conectar. Verifique URL/AnonKey.", "bad");
      }
    });

    /* ===============================================================
       2) Supabase via REST (fetch) ‚Äî sem libs
       - Auth: /auth/v1/token?grant_type=password
       - Logout: /auth/v1/logout
       - REST: /rest/v1/<table>
    =============================================================== */
    function mustConfig(){
      return !!(state.sbUrl && state.sbKey);
    }

    function sbHeaders(withAuth=true){
      const h = {
        apikey: state.sbKey,
        "Content-Type": "application/json",
      };
      if (withAuth && state.session?.access_token){
        h.Authorization = "Bearer " + state.session.access_token;
      } else {
        // para endpoints que precisam s√≥ do apikey, mas auth n√£o existe
        h.Authorization = "Bearer " + state.sbKey;
      }
      return h;
    }

    async function sbLogin(email, password){
      const url = state.sbUrl + "/auth/v1/token?grant_type=password";
      const res = await fetch(url, {
        method:"POST",
        headers: {
          apikey: state.sbKey,
          "Content-Type":"application/json",
        },
        body: JSON.stringify({ email, password })
      });
      const data = await safeJson(res);
      if (!res.ok) throw new Error(data?.error_description || data?.msg || "Falha no login");
      // data: { access_token, token_type, expires_in, refresh_token, user }
      state.session = { access_token: data.access_token, user: data.user, email: data.user?.email };
      $("#btnLogout").disabled = false;
      syncBadge();
      return state.session;
    }

    async function sbLogout(){
      if (!state.session?.access_token) return;
      try{
        await fetch(state.sbUrl + "/auth/v1/logout", {
          method:"POST",
          headers: sbHeaders(true),
          body: JSON.stringify({ scope: "global" })
        });
      }catch(_){}
      state.session = null;
      state.profile = null;
      $("#btnLogout").disabled = true;
      syncBadge();
      render();
    }

    async function sbSelect(table, query=""){
      const url = state.sbUrl + "/rest/v1/" + table + (query ? ("?" + query) : "");
      const res = await fetch(url, { headers: sbHeaders(true) });
      const data = await safeJson(res);
      if (!res.ok) throw new Error(data?.message || data?.hint || data?._raw || "Erro SELECT " + table);
      return data;
    }

    async function sbInsert(table, rows){
      const url = state.sbUrl + "/rest/v1/" + table;
      const res = await fetch(url, {
        method:"POST",
        headers: { ...sbHeaders(true), Prefer:"return=representation" },
        body: JSON.stringify(Array.isArray(rows) ? rows : [rows])
      });
      const data = await safeJson(res);
      if (!res.ok) throw new Error(data?.message || data?.hint || data?._raw || "Erro INSERT " + table);
      return data;
    }

    async function sbUpdate(table, matchQuery, patch){
      const url = state.sbUrl + "/rest/v1/" + table + "?" + matchQuery;
      const res = await fetch(url, {
        method:"PATCH",
        headers: { ...sbHeaders(true), Prefer:"return=representation" },
        body: JSON.stringify(patch)
      });
      const data = await safeJson(res);
      if (!res.ok) throw new Error(data?.message || data?.hint || data?._raw || "Erro UPDATE " + table);
      return data;
    }

    async function sbDelete(table, matchQuery){
      const url = state.sbUrl + "/rest/v1/" + table + "?" + matchQuery;
      const res = await fetch(url, {
        method:"DELETE",
        headers: sbHeaders(true)
      });
      if (!res.ok){
        const data = await safeJson(res);
        throw new Error(data?.message || data?.hint || data?._raw || "Erro DELETE " + table);
      }
      return true;
    }

    function syncBadge(){
      const hasCfg = mustConfig();
      if (!hasCfg){
        setBadge("warn","Sem configura√ß√£o");
        $("#uidShort").textContent = "‚Äî";
        return;
      }
      if (state.session?.user?.id){
        setBadge("ok","Autenticado");
        $("#uidShort").textContent = uidShort(state.session.user.id);
      }else{
        setBadge("warn","Pronto p/ login");
        $("#uidShort").textContent = "‚Äî";
      }
    }

    $("#btnLogout").addEventListener("click", sbLogout);

    /* ===============================================================
       3) Carregamento de dados (cache)
    =============================================================== */
    async function loadProfile(){
      if (!state.session?.user?.id) return null;
      // profiles: id = auth.uid()
      const rows = await sbSelect("profiles", `select=*&id=eq.${encodeURIComponent(state.session.user.id)}&limit=1`);
      state.profile = rows?.[0] || null;
      return state.profile;
    }

    async function loadStudents(){
      // esperamos coluna user_id nas tabelas. Se n√£o existir, ainda pode funcionar via RLS/pol√≠ticas, mas o ideal √© user_id.
      // query: select=*&order=created_at.desc
      const rows = await sbSelect("students", "select=*&order=created_at.desc");
      state.cache.students = Array.isArray(rows) ? rows : [];
      return state.cache.students;
    }

    async function loadExercises(){
      const rows = await sbSelect("exercises", "select=*&order=name.asc");
      state.cache.exercises = Array.isArray(rows) ? rows : [];
      return state.cache.exercises;
    }

    async function loadSessions(){
      const rows = await sbSelect("sessions", "select=*&order=date.desc");
      state.cache.sessions = Array.isArray(rows) ? rows : [];
      return state.cache.sessions;
    }

    async function refreshAll(){
      if (!state.session?.user?.id) return;
      state.loading = true;
      render();
      try{
        await Promise.all([
          loadProfile().catch(()=>null),
          loadStudents().catch(()=>[]),
          loadExercises().catch(()=>[]),
          loadSessions().catch(()=>[]),
        ]);
      }finally{
        state.loading = false;
        render();
      }
    }

    /* ===============================================================
       4) Render (Views)
    =============================================================== */
    function render(){
      setEnvTag();
      syncBadge();

      const root = $("#viewRoot");
      root.innerHTML = "";

      if (!mustConfig()){
        root.appendChild(viewNoConfig());
        return;
      }

      // Se n√£o logado: sempre mostrar tela de login (com op√ß√£o de continuar em modo leitura local)
      if (!state.session?.user?.id){
        root.appendChild(viewLogin());
        return;
      }

      // Logado
      const v = state.view;
      if (v === "dashboard") root.appendChild(viewDashboard());
      else if (v === "alunos") root.appendChild(viewAlunos());
      else if (v === "sessoes") root.appendChild(viewSessoes());
      else if (v === "exercicios") root.appendChild(viewExercicios());
      else if (v === "relatorios") root.appendChild(viewRelatorios());
      else if (v === "admin") root.appendChild(viewAdmin());
      else root.appendChild(viewDashboard());
    }

    function viewNoConfig(){
      const wrap = el("div", { class:"grid" }, [
        el("div", { class:"card" }, [
          el("h2", {}, ["Configura√ß√£o necess√°ria"]),
          el("p", {}, ["Este app precisa da URL e da ANON_KEY do seu projeto Supabase."]),
          el("div", { class:"actions" }, [
            el("button", { class:"btn ok", onclick: () => $("#btnOpenConfig").click() }, ["Abrir Config"]),
            el("button", { class:"btn", onclick: () => openModal("helpModal") }, ["Ajuda"]),
          ]),
          el("div", { class:"status" }, ["Sem configura√ß√£o. Cole SUPABASE_URL + SUPABASE_ANON_KEY para continuar."])
        ]),
        el("div", { class:"card" }, [
          el("h2", {}, ["Status do projeto"]),
          el("p", {}, ["Quando estiver configurado, faremos login e carregaremos: profiles, students, sessions, exercises."]),
          el("div", { class:"hr" }),
          el("div", { class:"muted", style:"font-size:13px; line-height:1.5" }, [
            el("div", {}, ["‚úÖ GitHub Pages: ok"]),
            el("div", {}, ["‚úÖ Dom√≠nio custom: ok (DNS/TLS pode levar um tempo para HTTPS)"]),
            el("div", {}, ["‚è≥ Pr√≥ximo: conectar Supabase via Config e logar."]),
          ])
        ])
      ]);
      return wrap;
    }

    function viewLogin(){
      const card = el("div", { class:"grid" }, [
        el("div", { class:"card" }, [
          el("h2", {}, ["Entrar (Supabase)"]),
          el("p", {}, ["Login por email/senha. Depois o app carrega seu perfil e dados."]),
          el("label", {}, ["Email"]),
          el("input", { id:"loginEmail", placeholder:"seuemail@dominio.com", value:"" }),
          el("label", {}, ["Senha"]),
          el("input", { id:"loginPass", type:"password", placeholder:"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" }),
          el("div", { class:"actions" }, [
            el("button", { class:"btn ok", onclick: doLogin }, ["Fazer login"]),
            el("button", { class:"btn", onclick: () => $("#btnOpenConfig").click() }, ["Config"]),
          ]),
          el("div", { id:"loginStatus", class:"status" }, ["Aguardando login‚Ä¶"])
        ]),
        el("div", { class:"card" }, [
          el("h2", {}, ["Diagn√≥stico"]),
          el("p", {}, ["Aqui voc√™ confere se a URL/AnonKey est√£o OK."]),
          el("div", { class:"row" }, [
            el("div", {}, [
              el("div", { class:"tag" }, ["SUPABASE_URL"]),
              el("div", { class:"mono", style:"margin-top:6px; font-size:12px; overflow-wrap:anywhere" }, [state.sbUrl || "‚Äî"])
            ]),
            el("div", {}, [
              el("div", { class:"tag" }, ["ANON_KEY"]),
              el("div", { class:"mono", style:"margin-top:6px; font-size:12px; overflow-wrap:anywhere" }, [state.sbKey ? (state.sbKey.slice(0,16)+"‚Ä¶") : "‚Äî"])
            ]),
          ]),
          el("div", { class:"hr" }),
          el("div", { class:"muted", style:"font-size:13px; line-height:1.5" }, [
            el("div", {}, ["Se der erro de login: confirme o usu√°rio no Supabase ‚Üí Authentication ‚Üí Users."]),
            el("div", {}, ["Se logar mas n√£o carrega dados: √© RLS/Pol√≠ticas ou colunas faltando."]),
          ])
        ]),
      ]);
      return card;
    }

    async function doLogin(){
      const email = $("#loginEmail").value.trim();
      const pass = $("#loginPass").value;
      const box = $("#loginStatus");
      box.className = "status";
      box.textContent = "Entrando‚Ä¶";
      try{
        await sbLogin(email, pass);
        box.className = "status ok";
        box.textContent = "Login OK. Carregando dados‚Ä¶";
        await refreshAll();
        setView("dashboard");
      }catch(err){
        box.className = "status bad";
        box.textContent = "Erro: " + (err?.message || "falha no login");
      }
    }

    function viewDashboard(){
      const name = state.profile?.name || "‚Äî";
      const cref = state.profile?.cref || "‚Äî";
      const slogan = state.profile?.slogan || "‚Äî";

      const students = state.cache.students || [];
      const sessions = state.cache.sessions || [];
      const exs = state.cache.exercises || [];

      const lastSession = sessions[0];
      const studentCount = students.length;
      const sessionCount = sessions.length;
      const exCount = exs.length;

      const wrap = el("div", { class:"grid" }, [
        el("div", { class:"card" }, [
          el("h2", {}, ["Dashboard"]),
          el("p", {}, ["Vis√£o geral do seu sistema."]),
          el("div", { class:"row" }, [
            metric("Profissional", name, "ok"),
            metric("CREF", cref, "warn"),
            metric("Slogan", slogan, ""),
          ]),
          el("div", { class:"hr" }),
          el("div", { class:"row" }, [
            metric("Alunos", String(studentCount), "ok"),
            metric("Sess√µes", String(sessionCount), "ok"),
            metric("Exerc√≠cios", String(exCount), "ok"),
          ]),
          el("div", { class:"hr" }),
          el("div", { class:"muted", style:"font-size:13px; line-height:1.55" }, [
            el("div", {}, ["√öltima sess√£o: ", el("span", { class:"mono" }, [ lastSession ? (lastSession.title || "Sess√£o") : "‚Äî" ]) ]),
            el("div", {}, ["Data: ", el("span", { class:"mono" }, [ lastSession ? fmtDate(lastSession.date || lastSession.created_at) : "‚Äî" ]) ]),
          ]),
          el("div", { class:"actions" }, [
            el("button", { class:"btn ok", onclick: refreshAll }, [ state.loading ? "Atualizando‚Ä¶" : "Atualizar tudo" ]),
            el("button", { class:"btn", onclick: () => setView("alunos") }, ["Ir para Alunos"]),
            el("button", { class:"btn", onclick: () => setView("sessoes") }, ["Ir para Sess√µes"]),
          ]),
          state.loading ? el("div", { class:"status" }, ["Carregando‚Ä¶"]) : el("div", { class:"status ok" }, ["Sistema operacional."])
        ]),

        el("div", { class:"card" }, [
          el("h2", {}, ["Checklist t√©cnico (V1)"]),
          el("p", {}, ["Confirma√ß√£o do ‚Äúpadr√£o completo‚Äù antes de evoluir."]),
          checkItem("Auth (login/logout) funcionando", !!state.session?.user?.id),
          checkItem("profiles criado (id = uid)", !!state.profile),
          checkItem("students acess√≠vel (RLS ok)", Array.isArray(state.cache.students)),
          checkItem("sessions acess√≠vel (RLS ok)", Array.isArray(state.cache.sessions)),
          checkItem("exercises acess√≠vel (RLS ok)", Array.isArray(state.cache.exercises)),
          el("div", { class:"hr" }),
          el("div", { class:"muted", style:"font-size:12px; line-height:1.6" }, [
            el("div", {}, ["Se algum item falhar: precisamos ajustar pol√≠ticas RLS/colunas (user_id) na tabela."]),
          ])
        ]),
      ]);

      return wrap;
    }

    function metric(labelTxt, valueTxt, kind=""){
      const t = el("div", { class:"tag " + (kind||"") }, [labelTxt]);
      const v = el("div", { class:"mono", style:"margin-top:6px; font-size:13px; overflow-wrap:anywhere" }, [valueTxt]);
      return el("div", {}, [t, v]);
    }

    function checkItem(txt, ok){
      return el("div", { style:"display:flex; align-items:center; justify-content:space-between; gap:10px; margin:8px 0" }, [
        el("div", { class:"muted" }, [txt]),
        el("span", { class:"tag " + (ok ? "ok":"bad") }, [ok ? "OK" : "Pendente"])
      ]);
    }

    /* ===============================================================
       5) Alunos (students)
    =============================================================== */
    function viewAlunos(){
      const wrap = el("div", { class:"grid" }, [
        el("div", { class:"card" }, [
          el("h2", {}, ["Alunos"]),
          el("p", {}, ["Cadastre e gerencie seus alunos."]),
          el("div", { class:"actions" }, [
            el("button", { class:"btn ok", onclick: () => openStudentModal() }, ["+ Novo aluno"]),
            el("button", { class:"btn", onclick: loadStudentsThenRender }, ["Recarregar"]),
          ]),
          el("div", { class:"hr" }),
          renderStudentsTable(),
        ]),
        el("div", { class:"card" }, [
          el("h2", {}, ["Dica operacional"]),
          el("p", {}, ["Padr√£o simples e escal√°vel: aluno ‚Üí sess√µes ‚Üí itens da sess√£o (exerc√≠cios)."]),
          el("div", { class:"muted", style:"font-size:13px; line-height:1.55" }, [
            el("div", {}, ["‚Ä¢ Use o nome completo no cadastro."]),
            el("div", {}, ["‚Ä¢ Defina objetivo e observa√ß√µes (les√µes, restri√ß√µes)."]),
            el("div", {}, ["‚Ä¢ Depois crie a sess√£o e vincule ao aluno."]),
          ])
        ])
      ]);
      return wrap;
    }

    async function loadStudentsThenRender(){
      state.loading = true; render();
      try{ await loadStudents(); }
      catch(e){ alert("Erro ao carregar alunos: " + e.message); }
      finally{ state.loading = false; render(); }
    }

    function renderStudentsTable(){
      const data = state.cache.students || [];
      if (!data.length){
        return el("div", { class:"status" }, ["Nenhum aluno ainda. Clique em ‚Äú+ Novo aluno‚Äù."]);
      }

      const table = el("table", {}, [
        el("thead", {}, [
          el("tr", {}, [
            el("th", {}, ["Nome"]),
            el("th", {}, ["Objetivo"]),
            el("th", {}, ["Criado"]),
            el("th", {}, ["A√ß√µes"]),
          ])
        ]),
        el("tbody", {}, data.map(row => {
          const name = row.name || row.full_name || "‚Äî";
          const goal = row.goal || row.objective || "‚Äî";
          const created = fmtDate(row.created_at);
          return el("tr", {}, [
            el("td", {}, [name]),
            el("td", { class:"muted" }, [goal]),
            el("td", { class:"muted" }, [created]),
            el("td", { class:"tdActions" }, [
              el("button", { class:"btn small", onclick: () => openStudentModal(row) }, ["Editar"]),
              " ",
              el("button", { class:"btn small", onclick: () => setView("sessoes") }, ["Sess√µes"]),
              " ",
              el("button", { class:"btn small bad", onclick: () => deleteStudent(row) }, ["Excluir"]),
            ])
          ]);
        }))
      ]);

      return el("div", {}, [table]);
    }

    function ensureUserIdPatch(obj){
      // Se sua tabela tiver user_id, vamos enviar.
      // Se n√£o tiver, o Supabase ignorar√°? (n√£o, vai dar erro). Ent√£o s√≥ adicionamos se estiver no modo "seguro":
      // Para ficar robusto sem conhecer seu schema, vamos TENTAR com user_id e, se falhar, tentar sem.
      return { ...obj, user_id: state.session?.user?.id };
    }

    async function insertSafe(table, obj){
      // tenta com user_id, se falhar por coluna inexistente, tenta sem
      try{
        return await sbInsert(table, ensureUserIdPatch(obj));
      }catch(e){
        const msg = (e.message||"");
        if (msg.includes("column") && msg.includes("user_id")){
          return await sbInsert(table, obj);
        }
        throw e;
      }
    }

    async function updateSafe(table, matchQuery, patch){
      try{
        return await sbUpdate(table, matchQuery, patch);
      }catch(e){
        throw e;
      }
    }

    // Student Modal
    function openStudentModal(existing=null){
      const backdrop = $("#configModal").cloneNode(true); // reaproveitar estilo? melhor criar modal espec√≠fico simples:
      // vamos criar um modal na hora:
      const back = el("div", { class:"modalBackdrop", style:"display:flex" });
      const m = el("div", { class:"modal" });

      const isEdit = !!existing;
      const title = isEdit ? "Editar aluno" : "Novo aluno";

      const inName = el("input", { value: existing?.name || existing?.full_name || "" });
      const inGoal = el("input", { value: existing?.goal || existing?.objective || "" });
      const inObs = el("textarea", {}, [ existing?.notes || existing?.obs || "" ]);

      m.appendChild(el("div", { class:"modalHead" }, [
        el("h3", {}, [title]),
        el("button", { class:"close", onclick: () => back.remove() }, ["Fechar"])
      ]));

      const body = el("div", { class:"modalBody" }, [
        el("div", { class:"row" }, [
          el("div", {}, [ el("label", {}, ["Nome"]), inName ]),
          el("div", {}, [ el("label", {}, ["Objetivo"]), inGoal ]),
        ]),
        el("label", {}, ["Observa√ß√µes"]),
        inObs,
        el("div", { class:"actions" }, [
          el("button", {
            class:"btn ok",
            onclick: async () => {
              const payload = {
                name: inName.value.trim(),
                goal: inGoal.value.trim(),
                notes: inObs.value.trim(),
              };
              if (!payload.name){
                alert("Preencha o nome.");
                return;
              }
              try{
                if (isEdit){
                  await updateSafe("students", `id=eq.${encodeURIComponent(existing.id)}`, payload);
                } else {
                  await insertSafe("students", payload);
                }
                await loadStudents();
                back.remove();
                render();
              }catch(e){
                alert("Erro ao salvar aluno: " + e.message);
              }
            }
          }, [isEdit ? "Salvar" : "Criar"]),
          el("button", { class:"btn", onclick: () => back.remove() }, ["Cancelar"])
        ])
      ]);
      m.appendChild(body);
      back.appendChild(m);
      document.body.appendChild(back);
    }

    async function deleteStudent(row){
      if (!confirm("Excluir este aluno? Isso n√£o apaga automaticamente as sess√µes vinculadas.")) return;
      try{
        await sbDelete("students", `id=eq.${encodeURIComponent(row.id)}`);
        await loadStudents();
        render();
      }catch(e){
        alert("Erro ao excluir: " + e.message);
      }
    }

    /* ===============================================================
       6) Sess√µes (sessions + session_items)
    =============================================================== */
    function viewSessoes(){
      const wrap = el("div", { class:"grid" }, [
        el("div", { class:"card" }, [
          el("h2", {}, ["Sess√µes"]),
          el("p", {}, ["Crie sess√µes, vincule a um aluno e registre itens (exerc√≠cios)."]),
          el("div", { class:"actions" }, [
            el("button", { class:"btn ok", onclick: () => openSessionModal() }, ["+ Nova sess√£o"]),
            el("button", { class:"btn", onclick: loadSessionsThenRender }, ["Recarregar"]),
          ]),
          el("div", { class:"hr" }),
          renderSessionsTable(),
        ]),
        el("div", { class:"card" }, [
          el("h2", {}, ["Registrar itens"]),
          el("p", {}, ["Ap√≥s criar uma sess√£o, clique em ‚ÄúItens‚Äù para registrar exerc√≠cios (s√©ries, repeti√ß√µes, carga, RPE, notas)."]),
          el("div", { class:"muted", style:"font-size:13px; line-height:1.55" }, [
            el("div", {}, ["Padr√£o sugerido do item (session_items):"]),
            el("div", { class:"mono", style:"font-size:12px; margin-top:8px" }, [
              "session_id, exercise_id, sets, reps, load, rpe, notes"
            ]),
          ])
        ])
      ]);
      return wrap;
    }

    async function loadSessionsThenRender(){
      state.loading = true; render();
      try{ await loadSessions(); }
      catch(e){ alert("Erro ao carregar sess√µes: " + e.message); }
      finally{ state.loading = false; render(); }
    }

    function renderSessionsTable(){
      const data = state.cache.sessions || [];
      if (!data.length){
        return el("div", { class:"status" }, ["Nenhuma sess√£o ainda. Clique em ‚Äú+ Nova sess√£o‚Äù."]);
      }

      const students = state.cache.students || [];
      const studentNameById = (id) => {
        const s = students.find(x => x.id === id);
        return s?.name || s?.full_name || "‚Äî";
      };

      const table = el("table", {}, [
        el("thead", {}, [
          el("tr", {}, [
            el("th", {}, ["Sess√£o"]),
            el("th", {}, ["Aluno"]),
            el("th", {}, ["Data"]),
            el("th", {}, ["Status"]),
            el("th", {}, ["A√ß√µes"]),
          ])
        ]),
        el("tbody", {}, data.map(row => {
          const title = row.title || row.name || "Sess√£o";
          const sid = row.student_id || row.student || null;
          const aluno = sid ? studentNameById(sid) : "‚Äî";
          const date = fmtDate(row.date || row.created_at);
          const status = (row.status || "planejada").toLowerCase();
          const tagClass = status.includes("concl") ? "ok" : (status.includes("cancel") ? "bad" : "warn");
          return el("tr", {}, [
            el("td", {}, [title]),
            el("td", { class:"muted" }, [aluno]),
            el("td", { class:"muted" }, [date]),
            el("td", {}, [ el("span", { class:"tag "+tagClass }, [status]) ]),
            el("td", { class:"tdActions" }, [
              el("button", { class:"btn small", onclick: () => openSessionModal(row) }, ["Editar"]),
              " ",
              el("button", { class:"btn small", onclick: () => openItemsModal(row) }, ["Itens"]),
              " ",
              el("button", { class:"btn small bad", onclick: () => deleteSession(row) }, ["Excluir"]),
            ])
          ]);
        }))
      ]);

      return el("div", {}, [table]);
    }

    function openSessionModal(existing=null){
      const back = el("div", { class:"modalBackdrop", style:"display:flex" });
      const m = el("div", { class:"modal" });

      const isEdit = !!existing;
      const title = isEdit ? "Editar sess√£o" : "Nova sess√£o";

      const students = state.cache.students || [];
      const selStudent = el("select", {});
      selStudent.appendChild(el("option", { value:"" }, ["(sem aluno)"]));
      students.forEach(s => {
        selStudent.appendChild(el("option", { value:s.id }, [s.name || s.full_name || "Aluno"]));
      });

      const inTitle = el("input", { value: existing?.title || existing?.name || "" , placeholder:"Ex: For√ßa ‚Äî Inferiores"} );
      const inDate = el("input", { type:"datetime-local" });
      const inStatus = el("select", {}, [
        el("option", { value:"planejada" }, ["planejada"]),
        el("option", { value:"executada" }, ["executada"]),
        el("option", { value:"cancelada" }, ["cancelada"]),
      ]);
      const inNotes = el("textarea", {}, [ existing?.notes || "" ]);

      if (existing?.student_id) selStudent.value = existing.student_id;
      if (existing?.status) inStatus.value = existing.status;

      // date: tenta converter ISO -> datetime-local
      if (existing?.date){
        const d = new Date(existing.date);
        if (!Number.isNaN(d.getTime())){
          const pad = (n) => String(n).padStart(2,"0");
          const val = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
          inDate.value = val;
        }
      }

      m.appendChild(el("div", { class:"modalHead" }, [
        el("h3", {}, [title]),
        el("button", { class:"close", onclick: () => back.remove() }, ["Fechar"])
      ]));

      const body = el("div", { class:"modalBody" }, [
        el("div", { class:"row" }, [
          el("div", {}, [ el("label", {}, ["T√≠tulo"]), inTitle ]),
          el("div", {}, [ el("label", {}, ["Aluno (opcional)"]), selStudent ]),
        ]),
        el("div", { class:"row" }, [
          el("div", {}, [ el("label", {}, ["Data/hora (opcional)"]), inDate ]),
          el("div", {}, [ el("label", {}, ["Status"]), inStatus ]),
        ]),
        el("label", {}, ["Notas"]),
        inNotes,
        el("div", { class:"actions" }, [
          el("button", {
            class:"btn ok",
            onclick: async () => {
              const payload = {
                title: inTitle.value.trim() || "Sess√£o",
                status: inStatus.value,
                notes: inNotes.value.trim(),
              };
              if (selStudent.value) payload.student_id = selStudent.value;

              if (inDate.value){
                const iso = new Date(inDate.value).toISOString();
                payload.date = iso;
              }

              try{
                if (isEdit){
                  await updateSafe("sessions", `id=eq.${encodeURIComponent(existing.id)}`, payload);
                } else {
                  await insertSafe("sessions", payload);
                }
                await loadSessions();
                back.remove();
                render();
              }catch(e){
                alert("Erro ao salvar sess√£o: " + e.message);
              }
            }
          }, [isEdit ? "Salvar" : "Criar"]),
          el("button", { class:"btn", onclick: () => back.remove() }, ["Cancelar"])
        ])
      ]);
      m.appendChild(body);
      back.appendChild(m);
      document.body.appendChild(back);
    }

    async function deleteSession(row){
      if (!confirm("Excluir esta sess√£o?")) return;
      try{
        await sbDelete("sessions", `id=eq.${encodeURIComponent(row.id)}`);
        await loadSessions();
        render();
      }catch(e){
        alert("Erro ao excluir sess√£o: " + e.message);
      }
    }

    async function openItemsModal(sessionRow){
      const back = el("div", { class:"modalBackdrop", style:"display:flex" });
      const m = el("div", { class:"modal" });

      const title = sessionRow?.title || "Sess√£o";

      const itemsBox = el("div", { class:"status" }, ["Carregando itens‚Ä¶"]);
      const exs = state.cache.exercises || [];

      const selEx = el("select", {});
      selEx.appendChild(el("option", { value:"" }, ["Selecione um exerc√≠cio"]));
      exs.forEach(ex => {
        selEx.appendChild(el("option", { value: ex.id }, [ex.name || "Exerc√≠cio"]));
      });

      const inSets = el("input", { placeholder:"S√©ries (ex: 4)", inputmode:"numeric" });
      const inReps = el("input", { placeholder:"Reps (ex: 8)", inputmode:"numeric" });
      const inLoad = el("input", { placeholder:"Carga (ex: 60)", inputmode:"decimal" });
      const inRpe  = el("input", { placeholder:"RPE (ex: 7)", inputmode:"decimal" });
      const inNotes= el("input", { placeholder:"Notas (opcional)" });

      m.appendChild(el("div", { class:"modalHead" }, [
        el("h3", {}, ["Itens da sess√£o ‚Äî " + title]),
        el("button", { class:"close", onclick: () => back.remove() }, ["Fechar"])
      ]));

      const body = el("div", { class:"modalBody" }, [
        el("div", { class:"card", style:"padding:12px; margin-bottom:12px" }, [
          el("div", { class:"muted", style:"font-size:13px; margin-bottom:10px" }, ["Adicionar item (exerc√≠cio)"]),
          el("div", { class:"row" }, [
            el("div", {}, [ el("label", {}, ["Exerc√≠cio"]), selEx ]),
            el("div", {}, [ el("label", {}, ["S√©ries"]), inSets ]),
            el("div", {}, [ el("label", {}, ["Reps"]), inReps ]),
          ]),
          el("div", { class:"row" }, [
            el("div", {}, [ el("label", {}, ["Carga"]), inLoad ]),
            el("div", {}, [ el("label", {}, ["RPE"]), inRpe ]),
            el("div", {}, [ el("label", {}, ["Notas"]), inNotes ]),
          ]),
          el("div", { class:"actions" }, [
            el("button", {
              class:"btn ok",
              onclick: async () => {
                if (!selEx.value){
                  alert("Selecione um exerc√≠cio.");
                  return;
                }
                const payload = {
                  session_id: sessionRow.id,
                  exercise_id: selEx.value,
                  sets: toNum(inSets.value),
                  reps: toNum(inReps.value),
                  load: toNum(inLoad.value),
                  rpe: toNum(inRpe.value),
                  notes: (inNotes.value || "").trim(),
                };
                try{
                  await insertSafe("session_items", payload);
                  // limpar campos
                  inSets.value = ""; inReps.value=""; inLoad.value=""; inRpe.value=""; inNotes.value="";
                  await loadSessionItems(sessionRow.id, itemsBox);
                }catch(e){
                  alert("Erro ao adicionar item: " + e.message);
                }
              }
            }, ["Adicionar item"]),
          ])
        ]),
        el("div", {}, [itemsBox])
      ]);
      m.appendChild(body);
      back.appendChild(m);
      document.body.appendChild(back);

      // load items
      await loadSessionItems(sessionRow.id, itemsBox);
    }

    function toNum(v){
      const t = String(v||"").trim().replace(",",".");
      if (!t) return null;
      const n = Number(t);
      return Number.isFinite(n) ? n : null;
    }

    async function loadSessionItems(sessionId, container){
      container.className = "status";
      container.textContent = "Carregando itens‚Ä¶";
      try{
        const rows = await sbSelect("session_items", `select=*&session_id=eq.${encodeURIComponent(sessionId)}&order=created_at.asc`);
        if (!rows.length){
          container.className = "status";
          container.textContent = "Sem itens ainda. Adicione o primeiro exerc√≠cio acima.";
          return;
        }
        container.className = "";
        container.innerHTML = "";

        const exs = state.cache.exercises || [];
        const exName = (id) => exs.find(e => e.id === id)?.name || "Exerc√≠cio";

        const table = el("table", {}, [
          el("thead", {}, [
            el("tr", {}, [
              el("th", {}, ["Exerc√≠cio"]),
              el("th", {}, ["S√©ries√óReps"]),
              el("th", {}, ["Carga"]),
              el("th", {}, ["RPE"]),
              el("th", {}, ["Notas"]),
              el("th", {}, ["A√ß√µes"]),
            ])
          ]),
          el("tbody", {}, rows.map(it => {
            return el("tr", {}, [
              el("td", {}, [exName(it.exercise_id)]),
              el("td", { class:"muted" }, [`${it.sets ?? "‚Äî"}√ó${it.reps ?? "‚Äî"}`]),
              el("td", { class:"muted" }, [it.load ?? "‚Äî"]),
              el("td", { class:"muted" }, [it.rpe ?? "‚Äî"]),
              el("td", { class:"muted" }, [it.notes || "‚Äî"]),
              el("td", { class:"tdActions" }, [
                el("button", { class:"btn small bad", onclick: async () => {
                  if (!confirm("Excluir este item?")) return;
                  try{
                    await sbDelete("session_items", `id=eq.${encodeURIComponent(it.id)}`);
                    await loadSessionItems(sessionId, container);
                  }catch(e){
                    alert("Erro ao excluir item: " + e.message);
                  }
                } }, ["Excluir"])
              ])
            ]);
          }))
        ]);

        container.appendChild(table);
      }catch(e){
        container.className = "status bad";
        container.textContent = "Erro ao carregar itens: " + e.message;
      }
    }

    /* ===============================================================
       7) Exerc√≠cios (exercises)
    =============================================================== */
    function viewExercicios(){
      const wrap = el("div", { class:"grid" }, [
        el("div", { class:"card" }, [
          el("h2", {}, ["Biblioteca de Exerc√≠cios"]),
          el("p", {}, ["Cadastre exerc√≠cios e use nas sess√µes."]),
          el("div", { class:"actions" }, [
            el("button", { class:"btn ok", onclick: () => openExerciseModal() }, ["+ Novo exerc√≠cio"]),
            el("button", { class:"btn", onclick: loadExercisesThenRender }, ["Recarregar"]),
          ]),
          el("div", { class:"hr" }),
          renderExercisesTable(),
        ]),
        el("div", { class:"card" }, [
          el("h2", {}, ["Seeds r√°pidos (opcional)"]),
          el("p", {}, ["Se voc√™ quiser, o Admin tem um bot√£o para inserir uma base inicial de exerc√≠cios."]),
          el("div", { class:"actions" }, [
            el("button", { class:"btn", onclick: () => setView("admin") }, ["Ir para Admin"])
          ])
        ])
      ]);
      return wrap;
    }

    async function loadExercisesThenRender(){
      state.loading = true; render();
      try{ await loadExercises(); }
      catch(e){ alert("Erro ao carregar exerc√≠cios: " + e.message); }
      finally{ state.loading = false; render(); }
    }

    function renderExercisesTable(){
      const data = state.cache.exercises || [];
      if (!data.length){
        return el("div", { class:"status" }, ["Nenhum exerc√≠cio ainda. Clique em ‚Äú+ Novo exerc√≠cio‚Äù ou use Seeds no Admin."]);
      }

      const table = el("table", {}, [
        el("thead", {}, [
          el("tr", {}, [
            el("th", {}, ["Nome"]),
            el("th", {}, ["Grupo"]),
            el("th", {}, ["Criado"]),
            el("th", {}, ["A√ß√µes"]),
          ])
        ]),
        el("tbody", {}, data.map(row => {
          const name = row.name || "‚Äî";
          const group = row.group || row.muscle_group || row.category || "‚Äî";
          const created = fmtDate(row.created_at);
          return el("tr", {}, [
            el("td", {}, [name]),
            el("td", { class:"muted" }, [group]),
            el("td", { class:"muted" }, [created]),
            el("td", { class:"tdActions" }, [
              el("button", { class:"btn small", onclick: () => openExerciseModal(row) }, ["Editar"]),
              " ",
              el("button", { class:"btn small bad", onclick: () => deleteExercise(row) }, ["Excluir"]),
            ])
          ]);
        }))
      ]);

      return el("div", {}, [table]);
    }

    function openExerciseModal(existing=null){
      const back = el("div", { class:"modalBackdrop", style:"display:flex" });
      const m = el("div", { class:"modal" });

      const isEdit = !!existing;
      const title = isEdit ? "Editar exerc√≠cio" : "Novo exerc√≠cio";

      const inName = el("input", { value: existing?.name || "" , placeholder:"Ex: Agachamento livre" });
      const inGroup = el("input", { value: existing?.group || existing?.muscle_group || existing?.category || "" , placeholder:"Ex: Quadr√≠ceps / Inferiores" });
      const inNotes = el("textarea", {}, [ existing?.notes || "" ]);

      m.appendChild(el("div", { class:"modalHead" }, [
        el("h3", {}, [title]),
        el("button", { class:"close", onclick: () => back.remove() }, ["Fechar"])
      ]));

      const body = el("div", { class:"modalBody" }, [
        el("div", { class:"row" }, [
          el("div", {}, [ el("label", {}, ["Nome"]), inName ]),
          el("div", {}, [ el("label", {}, ["Grupo"]), inGroup ]),
        ]),
        el("label", {}, ["Notas (opcional)"]),
        inNotes,
        el("div", { class:"actions" }, [
          el("button", {
            class:"btn ok",
            onclick: async () => {
              const payload = {
                name: inName.value.trim(),
                group: inGroup.value.trim(),
                notes: inNotes.value.trim(),
              };
              if (!payload.name){
                alert("Preencha o nome do exerc√≠cio.");
                return;
              }
              try{
                if (isEdit){
                  await sbUpdate("exercises", `id=eq.${encodeURIComponent(existing.id)}`, payload);
                } else {
                  await insertSafe("exercises", payload);
                }
                await loadExercises();
                back.remove();
                render();
              }catch(e){
                alert("Erro ao salvar exerc√≠cio: " + e.message);
              }
            }
          }, [isEdit ? "Salvar" : "Criar"]),
          el("button", { class:"btn", onclick: () => back.remove() }, ["Cancelar"])
        ])
      ]);
      m.appendChild(body);
      back.appendChild(m);
      document.body.appendChild(back);
    }

    async function deleteExercise(row){
      if (!confirm("Excluir este exerc√≠cio? (Se ele estiver usado em session_items, pode dar erro)")) return;
      try{
        await sbDelete("exercises", `id=eq.${encodeURIComponent(row.id)}`);
        await loadExercises();
        render();
      }catch(e){
        alert("Erro ao excluir: " + e.message);
      }
    }

    /* ===============================================================
       8) Relat√≥rios (export CSV)
    =============================================================== */
    function viewRelatorios(){
      const wrap = el("div", { class:"grid" }, [
        el("div", { class:"card" }, [
          el("h2", {}, ["Relat√≥rios"]),
          el("p", {}, ["Export simples (CSV) para alunos e sess√µes."]),
          el("div", { class:"actions" }, [
            el("button", { class:"btn ok", onclick: () => exportCsv("students", state.cache.students) }, ["Exportar alunos (CSV)"]),
            el("button", { class:"btn ok", onclick: () => exportCsv("sessions", state.cache.sessions) }, ["Exportar sess√µes (CSV)"]),
            el("button", { class:"btn", onclick: refreshAll }, ["Atualizar dados"]),
          ]),
          el("div", { class:"hr" }),
          el("div", { class:"muted", style:"font-size:13px; line-height:1.55" }, [
            el("div", {}, ["Pr√≥ximo upgrade (quando voc√™ pedir):"]),
            el("div", {}, ["‚Ä¢ PDF de relat√≥rio por aluno (hist√≥rico, cargas, frequ√™ncia)."]),
            el("div", {}, ["‚Ä¢ Painel de controle (PSR/PSE/Strain/ACWR) integrado."]),
          ])
        ]),
        el("div", { class:"card" }, [
          el("h2", {}, ["Observa√ß√£o"]),
          el("p", {}, ["Este V1 √© propositalmente simples e robusto em 1 arquivo."]),
          el("div", { class:"status" }, ["Quando voc√™ confirmar o schema final (colunas), eu travo o padr√£o e evolu√≠mos com seguran√ßa."])
        ])
      ]);
      return wrap;
    }

    function exportCsv(name, rows){
      if (!rows || !rows.length){
        alert("Sem dados para exportar.");
        return;
      }
      const cols = Object.keys(rows[0]);
      const esc = (v) => {
        if (v === null || v === undefined) return "";
        const s = String(v).replaceAll('"','""');
        return `"${s}"`;
      };
      const lines = [
        cols.join(","),
        ...rows.map(r => cols.map(c => esc(r[c])).join(","))
      ];
      const blob = new Blob([lines.join("\n")], { type:"text/csv;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `SPSV2_${name}_${new Date().toISOString().slice(0,10)}.csv`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    /* ===============================================================
       9) Admin
    =============================================================== */
    function viewAdmin(){
      const wrap = el("div", { class:"grid" }, [
        el("div", { class:"card" }, [
          el("h2", {}, ["Admin (padr√£o completo)"]),
          el("p", {}, ["A√ß√µes de manuten√ß√£o, seeds e diagn√≥stico."]),
          el("div", { class:"actions" }, [
            el("button", { class:"btn", onclick: refreshAll }, ["Recarregar tudo"]),
            el("button", { class:"btn", onclick: () => $("#btnOpenConfig").click() }, ["Config Supabase"]),
          ]),
          el("div", { class:"hr" }),
          el("div", { class:"actions" }, [
            el("button", { class:"btn ok", onclick: seedExercises }, ["Seed: Exerc√≠cios b√°sicos"]),
            el("button", { class:"btn", onclick: ensureProfileExists }, ["Garantir perfil (profiles)"]),
            el("button", { class:"btn bad", onclick: () => alert("Em V1 n√£o apagamos em massa. Seguran√ßa primeiro.") }, ["A√ß√µes destrutivas (bloqueado)"]),
          ]),
          el("div", { class:"hr" }),
          el("div", { class:"status" }, ["Admin pronto. Use seeds apenas se voc√™ quiser acelerar a base."])
        ]),
        el("div", { class:"card" }, [
          el("h2", {}, ["Estado atual"]),
          el("p", {}, ["Resumo do que est√° no navegador agora."]),
          el("div", { class:"muted", style:"font-size:13px; line-height:1.55" }, [
            el("div", {}, ["UID: ", el("span", { class:"mono" }, [state.session?.user?.id || "‚Äî"])]),
            el("div", {}, ["Email: ", el("span", { class:"mono" }, [state.session?.email || "‚Äî"])]),
            el("div", {}, ["Perfil: ", el("span", { class:"mono" }, [state.profile ? "OK" : "‚Äî"])]),
            el("div", {}, ["Alunos: ", el("span", { class:"mono" }, [String(state.cache.students?.length || 0)])]),
            el("div", {}, ["Sess√µes: ", el("span", { class:"mono" }, [String(state.cache.sessions?.length || 0)])]),
            el("div", {}, ["Exerc√≠cios: ", el("span", { class:"mono" }, [String(state.cache.exercises?.length || 0)])]),
          ])
        ])
      ]);
      return wrap;
    }

    async function ensureProfileExists(){
      try{
        const uid = state.session?.user?.id;
        if (!uid) return;
        // tenta buscar
        const rows = await sbSelect("profiles", `select=*&id=eq.${encodeURIComponent(uid)}&limit=1`);
        if (rows?.[0]){
          state.profile = rows[0];
          alert("Perfil j√° existe. OK.");
          render();
          return;
        }
        // cria m√≠nimo
        const payload = {
          id: uid,
          name: "Fabiano Samurai",
          cref: "CREF1:043866-G/RJ",
          slogan: "Personal na palma da sua m√£o",
          avatar_url: null,
          logo_url: null,
        };
        await sbInsert("profiles", payload);
        await loadProfile();
        alert("Perfil criado. OK.");
        render();
      }catch(e){
        alert("Erro ao garantir perfil: " + e.message);
      }
    }

    async function seedExercises(){
      try{
        const base = [
          { name:"Agachamento livre", group:"Inferiores", notes:"" },
          { name:"Leg press", group:"Inferiores", notes:"" },
          { name:"Stiff / Levantamento terra romeno", group:"Posterior", notes:"" },
          { name:"Cadeira extensora", group:"Quadr√≠ceps", notes:"" },
          { name:"Mesa flexora", group:"Posterior", notes:"" },
          { name:"Supino reto (barra)", group:"Peitoral", notes:"" },
          { name:"Supino inclinado (halteres)", group:"Peitoral", notes:"" },
          { name:"Crucifixo (halteres)", group:"Peitoral", notes:"" },
          { name:"Remada curvada", group:"Costas", notes:"" },
          { name:"Puxada na frente (aberta)", group:"Costas", notes:"" },
          { name:"Remada baixa", group:"Costas", notes:"" },
          { name:"Desenvolvimento militar", group:"Ombros", notes:"" },
          { name:"Eleva√ß√£o lateral", group:"Ombros", notes:"" },
          { name:"Rosca direta", group:"B√≠ceps", notes:"" },
          { name:"Tr√≠ceps corda", group:"Tr√≠ceps", notes:"" },
          { name:"Prancha", group:"Core", notes:"" },
        ];
        // inserir um por um (para n√£o travar se houver duplicatas/constraints)
        let ok = 0;
        for (const ex of base){
          try{ await insertSafe("exercises", ex); ok++; } catch(_){}
        }
        await loadExercises();
        alert(`Seed conclu√≠do. Inseridos: ${ok} (alguns podem j√° existir).`);
        render();
      }catch(e){
        alert("Erro no seed: " + e.message);
      }
    }

    /* ===============================================================
       10) Boot
    =============================================================== */
    (function boot(){
      setEnvTag();
      syncBadge();
      render();

      // ao carregar, se j√° tem config e quiser testar reachability:
      if (mustConfig()){
        // nada agressivo: s√≥ mant√©m badge
        setBadge(state.session?.user?.id ? "ok" : "warn", state.session?.user?.id ? "Autenticado" : "Pronto p/ login");
      }
    })();
  </script>
</body>
</html>
