<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SPSV2 ‚Äî Personal na Palma da Sua M√£o</title>
  <meta name="theme-color" content="#0b0f14" />

  <style>
    :root{
      --bg:#0b0f14;
      --panel:#0f1622;
      --card:rgba(255,255,255,.06);
      --card2:rgba(255,255,255,.04);
      --line:rgba(255,255,255,.10);
      --text:#eaf2fb;
      --muted:#9aa7b5;
      --ok:#2ee59d;
      --warn:#ffc66e;
      --bad:#ff5c77;
      --aqua:#64c8ff;
      --shadow:0 18px 60px rgba(0,0,0,.45);
      --r:18px;

      --btn:rgba(100,200,255,.12);
      --btn2:rgba(46,229,157,.12);
      --btn3:rgba(255,92,119,.12);
      --focus:rgba(100,200,255,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial;
      color:var(--text);
      background:
        radial-gradient(900px 520px at 15% 12%, rgba(100,200,255,.16), transparent 60%),
        radial-gradient(900px 520px at 85% 30%, rgba(46,229,157,.12), transparent 60%),
        radial-gradient(900px 520px at 55% 90%, rgba(255,198,110,.10), transparent 60%),
        var(--bg);
    }

    /* Layout */
    .app{min-height:100%; display:flex; gap:14px; padding:16px}
    .sidebar{
      width:290px; min-width:270px;
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius:20px;
      padding:14px;
      box-shadow:var(--shadow);
      backdrop-filter: blur(10px);
      position:sticky; top:16px; height:calc(100vh - 32px);
      display:flex; flex-direction:column; gap:12px;
    }
    .main{
      flex:1;
      display:flex;
      flex-direction:column;
      gap:14px;
      min-width: 320px;
    }
    .topbar{
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius:20px;
      padding:14px;
      box-shadow:var(--shadow);
      backdrop-filter: blur(10px);
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .content{
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius:20px;
      padding:14px;
      box-shadow:var(--shadow);
      backdrop-filter: blur(10px);
      min-height: calc(100vh - 32px - 84px);
    }

    /* Sidebar */
    .brand{display:flex; align-items:center; gap:10px}
    .brandLeft{display:flex; align-items:center; gap:10px; min-width:0}
    .avatar{
      width:42px;height:42px;border-radius:999px; /* ‚úÖ circular */
      background:linear-gradient(135deg, rgba(100,200,255,.35), rgba(46,229,157,.25));
      border:1px solid var(--line);
      box-shadow:0 10px 30px rgba(0,0,0,.30);
      overflow:hidden;
      flex:0 0 auto;
    }
    .avatar img{width:100%; height:100%; object-fit:cover; display:block}
    .brandText{min-width:0}
    .brand h1{margin:0; font-size:14px; letter-spacing:.5px}
    .brand .sub{margin:0; color:var(--muted); font-size:12px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .badge{
      margin-left:auto;
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px;
      border:1px solid var(--line);
      border-radius:999px;
      background:rgba(0,0,0,.18);
      color:var(--muted);
      font-size:12px;
      white-space:nowrap;
    }
    .dot{width:9px;height:9px;border-radius:9px;background:var(--warn); box-shadow:0 0 0 4px rgba(255,198,110,.12)}
    .dot.ok{background:var(--ok); box-shadow:0 0 0 4px rgba(46,229,157,.12)}
    .dot.bad{background:var(--bad); box-shadow:0 0 0 4px rgba(255,92,119,.12)}

    .nav{display:flex; flex-direction:column; gap:6px; margin-top:6px}
    .nav button{
      width:100%;
      text-align:left;
      border:1px solid transparent;
      background:transparent;
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .nav button:hover{background:rgba(255,255,255,.05)}
    .nav button.active{
      background:rgba(100,200,255,.10);
      border-color:rgba(100,200,255,.22);
    }
    .nav small{color:var(--muted)}
    .sidebar .foot{
      margin-top:auto;
      border-top:1px solid var(--line);
      padding-top:12px;
      display:flex; flex-direction:column; gap:10px;
      color:var(--muted);
      font-size:12px;
    }
    .miniRow{display:flex; gap:8px; align-items:center; justify-content:space-between}
    .pill{
      display:inline-flex; gap:8px; align-items:center;
      border:1px solid var(--line);
      background:rgba(0,0,0,.16);
      padding:8px 10px;
      border-radius:999px;
      font-size:12px;
      color:var(--muted);
      max-width: 100%;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }

    /* UI atoms */
    .grid{display:grid; grid-template-columns:1.35fr .95fr; gap:14px}
    @media (max-width: 1100px){
      .sidebar{display:none}
      .grid{grid-template-columns:1fr}
      .content{min-height:auto}
      .app{padding:10px}
    }

    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius:var(--r);
      padding:14px;
      box-shadow:0 10px 30px rgba(0,0,0,.25);
    }
    .card h2{margin:0 0 6px 0; font-size:16px}
    .card p{margin:0 0 10px 0; color:var(--muted); font-size:13px}

    label{display:block; color:var(--muted); font-size:12px; margin:10px 0 6px}
    input, select, textarea{
      width:100%;
      padding:11px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.18);
      color:var(--text);
      outline:none;
    }
    textarea{min-height:90px; resize:vertical}
    input:focus, select:focus, textarea:focus{border-color:var(--focus); box-shadow:0 0 0 4px rgba(100,200,255,.10)}
    .row{display:flex; gap:10px; flex-wrap:wrap}
    .row > *{flex:1}
    .actions{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px}
    .btn{
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px 12px;
      background:var(--btn);
      color:var(--text);
      cursor:pointer;
      font-weight:650;
    }
    .btn:hover{filter:brightness(1.05)}
    .btn.ok{background:var(--btn2)}
    .btn.bad{background:var(--btn3)}
    .btn.ghost{background:transparent}
    .btn.small{padding:8px 10px; border-radius:12px; font-weight:600; font-size:12px}
    .status{
      margin-top:12px;
      border:1px solid rgba(255,198,110,.25);
      background:rgba(255,198,110,.08);
      padding:10px 12px;
      border-radius:14px;
      color:var(--warn);
      font-size:13px;
      overflow-wrap:anywhere;
    }
    .status.ok{border-color:rgba(46,229,157,.25); background:rgba(46,229,157,.08); color:var(--ok)}
    .status.bad{border-color:rgba(255,92,119,.25); background:rgba(255,92,119,.08); color:var(--bad)}
    .muted{color:var(--muted)}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace}
    .hr{height:1px;background:var(--line); margin:12px 0}

    /* Tables */
    table{width:100%; border-collapse:collapse; overflow:hidden; border-radius:14px}
    th, td{padding:10px 10px; border-bottom:1px solid rgba(255,255,255,.08); vertical-align:top}
    th{color:var(--muted); font-size:12px; text-transform:uppercase; letter-spacing:.06em; text-align:left}
    tr:hover td{background:rgba(255,255,255,.03)}
    .tdActions{white-space:nowrap}
    .tag{
      display:inline-flex; align-items:center; gap:6px;
      padding:5px 9px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.16);
      color:var(--muted);
      font-size:12px;
    }
    .tag.ok{border-color:rgba(46,229,157,.25); color:var(--ok); background:rgba(46,229,157,.08)}
    .tag.warn{border-color:rgba(255,198,110,.25); color:var(--warn); background:rgba(255,198,110,.08)}
    .tag.bad{border-color:rgba(255,92,119,.25); color:var(--bad); background:rgba(255,92,119,.08)}
    .right{display:flex; align-items:center; gap:10px; justify-content:flex-end}

    /* Modal */
    .modalBackdrop{
      position:fixed; inset:0;
      background:rgba(0,0,0,.60);
      display:none;
      align-items:center; justify-content:center;
      padding:16px;
      z-index:9999;
    }
    .modal{
      width:min(900px, 100%);
      background:linear-gradient(180deg, rgba(15,22,34,.96), rgba(10,14,20,.92));
      border:1px solid var(--line);
      border-radius:22px;
      box-shadow:var(--shadow);
      padding:14px;
    }
    .modalHead{display:flex; align-items:center; justify-content:space-between; gap:10px}
    .modalHead h3{margin:0; font-size:16px}
    .close{background:transparent; border:1px solid var(--line); color:var(--text); border-radius:12px; padding:8px 10px; cursor:pointer}
    .modalBody{margin-top:10px}
    .footer{
      margin-top:12px;
      text-align:center;
      color:var(--muted);
      font-size:12px;
      padding:10px 0 4px;
    }
  </style>
</head>

<body>
  <div class="app">
    <aside class="sidebar">
      <div class="brand">
        <div class="brandLeft">
          <div class="avatar" aria-hidden="true" id="avatarBox">
            <!-- avatar_url (profiles) vai aqui -->
          </div>
          <div class="brandText">
            <h1>SPSV2</h1>
            <p class="sub" id="brandSub">Personal na Palma da Sua M√£o</p>
          </div>
        </div>

        <div class="badge" title="Status do Supabase e sess√£o">
          <span id="dot" class="dot"></span>
          <span id="badgeText">Desconectado</span>
        </div>
      </div>

      <div class="nav" id="nav">
        <button data-view="dashboard" class="active"><span>üè† Dashboard</span><small>Vis√£o geral</small></button>
        <button data-view="alunos"><span>üë• Alunos</span><small>Cadastro e hist√≥rico</small></button>
        <button data-view="sessoes"><span>üóìÔ∏è Sess√µes</span><small>Treinos e controle</small></button>
        <button data-view="exercicios"><span>üèãÔ∏è Exerc√≠cios</span><small>Biblioteca</small></button>
        <button data-view="relatorios"><span>üìÑ Relat√≥rios</span><small>Export/prints</small></button>
        <button data-view="admin"><span>üõ°Ô∏è Admin</span><small>Configura√ß√µes</small></button>
      </div>

      <div class="foot">
        <div class="miniRow">
          <span class="pill" title="Projeto Supabase">
            ‚úÖ <span class="mono" id="sbHost">supabase</span>
          </span>
          <button class="btn small ghost" id="btnOpenConfig">Config</button>
        </div>
        <div class="miniRow">
          <span class="muted">Sess√£o:</span>
          <span class="mono" id="uidShort">‚Äî</span>
        </div>
      </div>
    </aside>

    <main class="main">
      <div class="topbar">
        <div>
          <div style="font-weight:750; letter-spacing:.2px">SPSV2 ‚Äî Painel Completo</div>
          <div class="muted" style="font-size:12px; margin-top:2px" id="subtitle">
            Alunos ‚Ä¢ Sess√µes ‚Ä¢ Exerc√≠cios ‚Ä¢ Relat√≥rios ‚Ä¢ Admin
          </div>
        </div>

        <div class="right">
          <span class="tag" id="tagEnv">GitHub Pages</span>
          <button class="btn ghost" id="btnQuickHelp">Ajuda</button>
          <button class="btn" id="btnLogout" disabled>Sair</button>
        </div>
      </div>

      <div class="content">
        <div id="viewRoot"></div>
        <div class="footer">Editora Samurai ‚Äî CNPJ 51.041.045/0001-45 ‚Äî Todos os direitos reservados.</div>
      </div>
    </main>
  </div>

  <!-- Modal: Config -->
  <div class="modalBackdrop" id="configModal">
    <div class="modal">
      <div class="modalHead">
        <h3>Configura√ß√£o (Supabase)</h3>
        <button class="close" data-close="configModal">Fechar</button>
      </div>
      <div class="modalBody">
        <p class="muted" style="margin:0 0 10px 0">
          Cole aqui a URL do seu projeto e a <b>Anon Key (Publishable key)</b>. Isso fica salvo no seu navegador (localStorage).
        </p>
        <div class="row">
          <div>
            <label>SUPABASE_URL</label>
            <input id="cfgUrl" placeholder="https://xxxxx.supabase.co" />
          </div>
          <div>
            <label>SUPABASE_ANON_KEY (Publishable key)</label>
            <input id="cfgKey" placeholder="sb_publishable_..." />
          </div>
        </div>
        <div class="actions">
          <button class="btn ok" id="btnSaveConfig">Salvar</button>
          <button class="btn" id="btnTestConn">Testar conex√£o</button>
          <button class="btn bad" id="btnClearConfig">Limpar</button>
        </div>
        <div id="cfgStatus" class="status">Cole sua URL e Anon Key para habilitar o app.</div>

        <div class="hr"></div>
        <details>
          <summary style="cursor:pointer; color:var(--muted)">Mapa r√°pido do seu schema (padr√£o atual)</summary>
          <div style="margin-top:10px; color:var(--muted); font-size:13px; line-height:1.5">
            <div><b>Tabelas:</b> profiles, students, sessions, exercises, session_items</div>
            <div><b>Chaves:</b> profiles.id = auth.users.id</div>
            <div><b>Sessions:</b> usa <span class="mono">session_date</span> (date) + <span class="mono">status</span></div>
            <div><b>Exercises:</b> usa <span class="mono">group_name</span></div>
            <div><b>Session items:</b> sets / reps / load / rpe / notes</div>
          </div>
        </details>
      </div>
    </div>
  </div>

  <!-- Modal: Ajuda -->
  <div class="modalBackdrop" id="helpModal">
    <div class="modal">
      <div class="modalHead">
        <h3>Ajuda r√°pida</h3>
        <button class="close" data-close="helpModal">Fechar</button>
      </div>
      <div class="modalBody" style="color:var(--muted); font-size:13px; line-height:1.55">
        <p style="margin-top:0">
          <b>Fluxo V1:</b> Config ‚Üí Login ‚Üí Alunos ‚Üí Sess√µes ‚Üí Itens (exerc√≠cios) ‚Üí Relat√≥rios.
        </p>
        <p>
          <b>Se aparecer ‚ÄúCould not find the 'X' column ‚Ä¶‚Äù</b>: seu banco n√£o tem essa coluna.
          Este app tenta se adaptar automaticamente, mas se voc√™ estiver criando colunas manualmente,
          mantenha os nomes assim: <span class="mono">goal</span>, <span class="mono">status</span>, <span class="mono">session_date</span>, <span class="mono">group_name</span>.
        </p>
        <p>
          <b>Treinos especiais (regressivos):</b> nos Itens da sess√£o voc√™ tem um campo <span class="mono">M√©todo</span> e um campo <span class="mono">Esquema</span>.
          Se o banco ainda n√£o tiver essas colunas, o sistema salva no <span class="mono">notes</span> automaticamente.
        </p>
      </div>
    </div>
  </div>

  <script>
    /*****************************************************************
     * SPSV2 ‚Äî Personal na Palma da Sua M√£o (Single-file)
     *
     * ‚úÖ Corre√ß√µes principais desta vers√£o:
     * 1) FUN√á√ÉO el() ‚Äú√† prova de bug‚Äù:
     *    - Converte n√∫meros/booleans em texto automaticamente.
     *    - Isso resolve o erro: appendChild parameter 1 is not of type Node
     *
     * 2) Alinhamento com seu schema real (prints):
     *    - students.goal
     *    - sessions.session_date (date) + sessions.status
     *    - exercises.group_name
     *    - session_items (j√° existe e cont√©m sets/reps/load/rpe/notes)
     *
     * 3) Itens da sess√£o com M√©todo/Esquema (para regressivos):
     *    - Se existirem colunas method/scheme no banco, salvamos nelas.
     *    - Se N√ÉO existirem, colocamos dentro de notes automaticamente.
     *
     * 4) Avatar/Logo:
     *    - Avatar circular (n√£o oval) ‚úÖ
     *    - Se profiles.avatar_url existir, mostra na sidebar.
     *****************************************************************/

    /* ===============================================================
       0) CONFIG (URL/ANON) ‚Äî salva no navegador
    =============================================================== */
    const LS = {
      url: "SPSV2_SUPABASE_URL",
      key: "SPSV2_SUPABASE_ANON",
      lastView: "SPSV2_LAST_VIEW",
    };

    const TABLES = {
      profiles: "profiles",
      students: "students",
      sessions: "sessions",
      exercises: "exercises",
      items: "session_items",
    };

    // Colunas (alinhadas com o que voc√™ j√° criou)
    const COL = {
      profiles: { id:"id", name:"name", cref:"cref", slogan:"slogan", avatar_url:"avatar_url", logo_url:"logo_url" },
      students: { id:"id", user_id:"user_id", name:"name", goal:"goal", notes:"notes", created_at:"created_at" },
      sessions: { id:"id", user_id:"user_id", student_id:"student_id", title:"title", status:"status", session_date:"session_date", notes:"notes", created_at:"created_at" },
      exercises:{ id:"id", user_id:"user_id", name:"name", group_name:"group_name", notes:"notes", created_at:"created_at" },
      items:   { id:"id", user_id:"user_id", session_id:"session_id", exercise_id:"exercise_id", sets:"sets", reps:"reps", load:"load", rpe:"rpe", notes:"notes",
                 // opcionais para ‚Äúm√©todos regressivos‚Äù
                 method:"method", scheme:"scheme"
               },
    };

    const state = {
      sbUrl: localStorage.getItem(LS.url) || "",
      sbKey: localStorage.getItem(LS.key) || "",
      session: null,      // { access_token, user: { id, email } }
      profile: null,      // row from profiles
      view: localStorage.getItem(LS.lastView) || "dashboard",
      loading: false,
      cache: { students: [], sessions: [], exercises: [] },
    };

    /* ===============================================================
       1) UTILIDADES (DOM, datas, etc.)
    =============================================================== */
    const $ = (sel) => document.querySelector(sel);

    // ‚úÖ el() ‚Äú√† prova de bug‚Äù
    // - N√£o quebra com n√∫mero/boolean/null
    // - Aceita arrays de filhos
    const el = (tag, attrs = {}, children = []) => {
      const n = document.createElement(tag);

      for (const [k, v] of Object.entries(attrs || {})) {
        if (k === "class") n.className = v;
        else if (k === "html") n.innerHTML = v;
        else if (k.startsWith("on") && typeof v === "function") n.addEventListener(k.slice(2), v);
        else if (v !== null && v !== undefined) n.setAttribute(k, v);
      }

      (children || []).forEach((c) => {
        if (c === null || c === undefined) return;

        if (c instanceof Node) { n.appendChild(c); return; }

        if (Array.isArray(c)) {
          c.forEach((cc) => {
            if (cc === null || cc === undefined) return;
            n.appendChild(cc instanceof Node ? cc : document.createTextNode(String(cc)));
          });
          return;
        }

        n.appendChild(document.createTextNode(String(c)));
      });

      return n;
    };

    const safeJson = async (res) => {
      const txt = await res.text();
      try { return JSON.parse(txt); } catch { return { _raw: txt }; }
    };

    const fmtDateTime = (iso) => {
      if (!iso) return "‚Äî";
      const d = new Date(iso);
      if (Number.isNaN(d.getTime())) return String(iso);
      return d.toLocaleString("pt-BR");
    };

    const fmtDateOnly = (yyyy_mm_dd) => {
      if (!yyyy_mm_dd) return "‚Äî";
      // se vier ISO, pega s√≥ data
      const s = String(yyyy_mm_dd);
      const d = s.length >= 10 ? s.slice(0,10) : s;
      const parts = d.split("-");
      if (parts.length === 3) return `${parts[2]}/${parts[1]}/${parts[0]}`;
      return d;
    };

    const uidShort = (uid) => uid ? (uid.slice(0,8)+"‚Ä¶"+uid.slice(-4)) : "‚Äî";

    const setBadge = (mode, text) => {
      const dot = $("#dot");
      const badgeText = $("#badgeText");
      dot.classList.remove("ok","bad");
      if (mode === "ok") dot.classList.add("ok");
      if (mode === "bad") dot.classList.add("bad");
      badgeText.textContent = text;
    };

    const openModal = (id) => { $("#"+id).style.display = "flex"; };
    const closeModal = (id) => { $("#"+id).style.display = "none"; };

    document.addEventListener("click", (e) => {
      const btn = e.target.closest("[data-close]");
      if (btn) closeModal(btn.getAttribute("data-close"));
      const navBtn = e.target.closest("#nav button[data-view]");
      if (navBtn) setView(navBtn.dataset.view);
    });

    function setEnvTag() {
      const isGh = location.host.includes("github.io");
      $("#tagEnv").textContent = isGh ? "GitHub Pages" : "Web";
      $("#sbHost").textContent = state.sbUrl ? (new URL(state.sbUrl).host) : "supabase";
    }

    function setView(view) {
      state.view = view;
      localStorage.setItem(LS.lastView, view);
      document.querySelectorAll("#nav button").forEach(b => b.classList.toggle("active", b.dataset.view === view));
      render();
    }

    function mustConfig(){ return !!(state.sbUrl && state.sbKey); }

    function syncBadge(){
      if (!mustConfig()){
        setBadge("warn","Sem configura√ß√£o");
        $("#uidShort").textContent = "‚Äî";
        return;
      }
      if (state.session?.user?.id){
        setBadge("ok","Autenticado");
        $("#uidShort").textContent = uidShort(state.session.user.id);
      } else {
        setBadge("warn","Pronto p/ login");
        $("#uidShort").textContent = "‚Äî";
      }
    }

    function cfgStatus(msg, type="warn"){
      const box = $("#cfgStatus");
      box.className = "status";
      if (type === "ok") box.classList.add("ok");
      if (type === "bad") box.classList.add("bad");
      box.textContent = msg;
    }

    /* ===============================================================
       2) SUPABASE (REST + AUTH) ‚Äî sem libs
    =============================================================== */
    function sbHeaders(withAuth=true){
      const h = {
        apikey: state.sbKey,
        "Content-Type": "application/json",
      };
      if (withAuth && state.session?.access_token){
        h.Authorization = "Bearer " + state.session.access_token;
      } else {
        h.Authorization = "Bearer " + state.sbKey;
      }
      return h;
    }

    async function sbLogin(email, password){
      const url = state.sbUrl + "/auth/v1/token?grant_type=password";
      const res = await fetch(url, {
        method:"POST",
        headers: { apikey: state.sbKey, "Content-Type":"application/json" },
        body: JSON.stringify({ email, password })
      });
      const data = await safeJson(res);
      if (!res.ok) throw new Error(data?.error_description || data?.msg || "Falha no login");
      state.session = { access_token: data.access_token, user: data.user, email: data.user?.email };
      $("#btnLogout").disabled = false;
      syncBadge();
      return state.session;
    }

    async function sbLogout(){
      if (!state.session?.access_token) return;
      try{
        await fetch(state.sbUrl + "/auth/v1/logout", {
          method:"POST",
          headers: sbHeaders(true),
          body: JSON.stringify({ scope: "global" })
        });
      }catch(_){}
      state.session = null;
      state.profile = null;
      $("#btnLogout").disabled = true;
      syncBadge();
      render();
    }

    async function sbSelect(table, query=""){
      const url = state.sbUrl + "/rest/v1/" + table + (query ? ("?" + query) : "");
      const res = await fetch(url, { headers: sbHeaders(true) });
      const data = await safeJson(res);
      if (!res.ok) throw new Error(data?.message || data?.hint || data?._raw || ("Erro SELECT " + table));
      return data;
    }

    async function sbInsert(table, rows){
      const url = state.sbUrl + "/rest/v1/" + table;
      const res = await fetch(url, {
        method:"POST",
        headers: { ...sbHeaders(true), Prefer:"return=representation" },
        body: JSON.stringify(Array.isArray(rows) ? rows : [rows])
      });
      const data = await safeJson(res);
      if (!res.ok) throw new Error(data?.message || data?.hint || data?._raw || ("Erro INSERT " + table));
      return data;
    }

    async function sbUpdate(table, matchQuery, patch){
      const url = state.sbUrl + "/rest/v1/" + table + "?" + matchQuery;
      const res = await fetch(url, {
        method:"PATCH",
        headers: { ...sbHeaders(true), Prefer:"return=representation" },
        body: JSON.stringify(patch)
      });
      const data = await safeJson(res);
      if (!res.ok) throw new Error(data?.message || data?.hint || data?._raw || ("Erro UPDATE " + table));
      return data;
    }

    async function sbDelete(table, matchQuery){
      const url = state.sbUrl + "/rest/v1/" + table + "?" + matchQuery;
      const res = await fetch(url, { method:"DELETE", headers: sbHeaders(true) });
      if (!res.ok){
        const data = await safeJson(res);
        throw new Error(data?.message || data?.hint || data?._raw || ("Erro DELETE " + table));
      }
      return true;
    }

    // Insert ‚Äúinteligente‚Äù: tenta com user_id e remove colunas inexistentes automaticamente
    function withUserId(obj){
      const uid = state.session?.user?.id;
      if (!uid) return { ...obj };
      // Se sua tabela tiver user_id, isso ajuda o RLS.
      return { ...obj, user_id: uid };
    }

    function extractMissingColumn(msg){
      // Erros comuns:
      // 1) Could not find the 'goal' column of 'students' in the schema cache
      const m1 = msg.match(/Could not find the '([^']+)' column/i);
      if (m1 && m1[1]) return m1[1];

      // 2) column "sets" of relation "session_items" does not exist
      const m2 = msg.match(/column "([^"]+)" of relation/i);
      if (m2 && m2[1]) return m2[1];

      return null;
    }

    async function insertSmart(table, payload){
      // 1) tenta com user_id
      let obj = withUserId(payload);

      // 2) tenta remover colunas inexistentes (at√© 6 tentativas)
      for (let i=0; i<6; i++){
        try{
          return await sbInsert(table, obj);
        }catch(e){
          const msg = String(e?.message || "");
          const col = extractMissingColumn(msg);

          // se erro for user_id n√£o existente -> remove e tenta de novo
          if (col && Object.prototype.hasOwnProperty.call(obj, col)){
            const clone = { ...obj };
            delete clone[col];
            obj = clone;
            continue;
          }

          // se n√£o conseguimos corrigir automaticamente, explode
          throw e;
        }
      }
      return await sbInsert(table, obj);
    }

    async function updateSmart(table, matchQuery, patch){
      // update tamb√©m: remove colunas inexistentes se acontecer
      let obj = { ...patch };
      for (let i=0; i<6; i++){
        try{
          return await sbUpdate(table, matchQuery, obj);
        }catch(e){
          const msg = String(e?.message || "");
          const col = extractMissingColumn(msg);
          if (col && Object.prototype.hasOwnProperty.call(obj, col)){
            const clone = { ...obj };
            delete clone[col];
            obj = clone;
            continue;
          }
          throw e;
        }
      }
      return await sbUpdate(table, matchQuery, obj);
    }

    /* ===============================================================
       3) CARREGAMENTO / CACHE
    =============================================================== */
    async function loadProfile(){
      if (!state.session?.user?.id) return null;
      const uid = state.session.user.id;
      const rows = await sbSelect(TABLES.profiles, `select=*&${COL.profiles.id}=eq.${encodeURIComponent(uid)}&limit=1`);
      state.profile = rows?.[0] || null;

      // aplica avatar
      applyAvatarFromProfile();
      return state.profile;
    }

    function applyAvatarFromProfile(){
      const box = $("#avatarBox");
      box.innerHTML = "";
      const url = state.profile?.[COL.profiles.avatar_url];
      if (url){
        box.appendChild(el("img", { src:url, alt:"Avatar" }));
      }
      const slogan = state.profile?.[COL.profiles.slogan];
      if (slogan) $("#brandSub").textContent = slogan;
    }

    async function loadStudents(){
      const rows = await sbSelect(TABLES.students, `select=*&order=${COL.students.created_at}.desc`);
      state.cache.students = Array.isArray(rows) ? rows : [];
      return state.cache.students;
    }

    async function loadExercises(){
      const rows = await sbSelect(TABLES.exercises, `select=*&order=${COL.exercises.name}.asc`);
      state.cache.exercises = Array.isArray(rows) ? rows : [];
      return state.cache.exercises;
    }

    async function loadSessions(){
      // Ordena por session_date desc (se tiver), sen√£o created_at desc
      let rows = [];
      try{
        rows = await sbSelect(TABLES.sessions, `select=*&order=${COL.sessions.session_date}.desc`);
      }catch(_){
        rows = await sbSelect(TABLES.sessions, `select=*&order=${COL.sessions.created_at}.desc`);
      }
      state.cache.sessions = Array.isArray(rows) ? rows : [];
      return state.cache.sessions;
    }

    async function refreshAll(){
      if (!state.session?.user?.id) return;
      state.loading = true;
      render();
      try{
        await Promise.all([
          loadProfile().catch(()=>null),
          loadStudents().catch(()=>[]),
          loadExercises().catch(()=>[]),
          loadSessions().catch(()=>[]),
        ]);
      }finally{
        state.loading = false;
        render();
      }
    }

    /* ===============================================================
       4) BOT√ïES TOP / CONFIG
    =============================================================== */
    $("#btnOpenConfig").addEventListener("click", () => {
      $("#cfgUrl").value = state.sbUrl || "";
      $("#cfgKey").value = state.sbKey || "";
      cfgStatus("Cole a URL e Publishable key e clique em Salvar.", "warn");
      openModal("configModal");
    });

    $("#btnQuickHelp").addEventListener("click", () => openModal("helpModal"));
    $("#btnLogout").addEventListener("click", sbLogout);

    $("#btnSaveConfig").addEventListener("click", () => {
      const url = $("#cfgUrl").value.trim();
      const key = $("#cfgKey").value.trim();
      if (!url || !key){
        cfgStatus("Faltou preencher URL e/ou ANON_KEY.", "bad");
        return;
      }
      state.sbUrl = url;
      state.sbKey = key;
      localStorage.setItem(LS.url, url);
      localStorage.setItem(LS.key, key);
      setEnvTag();
      cfgStatus("Config salvo. Agora clique em Testar conex√£o e depois feche.", "ok");
      syncBadge();
      render();
    });

    $("#btnClearConfig").addEventListener("click", () => {
      localStorage.removeItem(LS.url);
      localStorage.removeItem(LS.key);
      state.sbUrl = "";
      state.sbKey = "";
      state.session = null;
      state.profile = null;
      state.cache = { students:[], sessions:[], exercises:[] };
      setEnvTag();
      setBadge("warn","Desconectado");
      $("#btnLogout").disabled = true;
      $("#uidShort").textContent = "‚Äî";
      cfgStatus("Config limpo. Cole novamente para usar o app.", "warn");
      render();
    });

    $("#btnTestConn").addEventListener("click", async () => {
      if (!state.sbUrl || !state.sbKey){
        cfgStatus("Sem URL/AnonKey. Salve primeiro.", "bad");
        return;
      }
      cfgStatus("Testando conex√£o‚Ä¶", "warn");
      try{
        const res = await fetch(state.sbUrl + "/rest/v1/", {
          headers: { apikey: state.sbKey, Authorization: "Bearer " + state.sbKey }
        });
        // S√≥ precisamos que responda (n√£o importa o status)
        cfgStatus("Conex√£o OK (servidor respondeu).", "ok");
      }catch(err){
        cfgStatus("Falha ao conectar. Verifique URL/AnonKey.", "bad");
      }
    });

    /* ===============================================================
       5) RENDER (Views)
    =============================================================== */
    function render(){
      setEnvTag();
      syncBadge();

      const root = $("#viewRoot");
      root.innerHTML = "";

      if (!mustConfig()){
        root.appendChild(viewNoConfig());
        return;
      }

      if (!state.session?.user?.id){
        root.appendChild(viewLogin());
        return;
      }

      // Logado
      const v = state.view;
      if (v === "dashboard") root.appendChild(viewDashboard());
      else if (v === "alunos") root.appendChild(viewAlunos());
      else if (v === "sessoes") root.appendChild(viewSessoes());
      else if (v === "exercicios") root.appendChild(viewExercicios());
      else if (v === "relatorios") root.appendChild(viewRelatorios());
      else if (v === "admin") root.appendChild(viewAdmin());
      else root.appendChild(viewDashboard());
    }

    function viewNoConfig(){
      return el("div", { class:"grid" }, [
        el("div", { class:"card" }, [
          el("h2", {}, ["Configura√ß√£o necess√°ria"]),
          el("p", {}, ["Este app precisa da URL e da Publishable key (Anon Key) do seu projeto Supabase."]),
          el("div", { class:"actions" }, [
            el("button", { class:"btn ok", onclick: () => $("#btnOpenConfig").click() }, ["Abrir Config"]),
            el("button", { class:"btn", onclick: () => openModal("helpModal") }, ["Ajuda"]),
          ]),
          el("div", { class:"status" }, ["Sem configura√ß√£o. Cole SUPABASE_URL + SUPABASE_ANON_KEY para continuar."])
        ]),
        el("div", { class:"card" }, [
          el("h2", {}, ["Status do projeto"]),
          el("p", {}, ["Quando estiver configurado, faremos login e carregaremos: profiles, students, sessions, exercises."]),
          el("div", { class:"hr" }),
          el("div", { class:"muted", style:"font-size:13px; line-height:1.5" }, [
            "‚úÖ GitHub Pages: ok",
            el("br"),
            "‚úÖ Dom√≠nio custom: ok",
            el("br"),
            "‚è≥ Pr√≥ximo: conectar Supabase via Config e logar."
          ])
        ])
      ]);
    }

    function viewLogin(){
      return el("div", { class:"grid" }, [
        el("div", { class:"card" }, [
          el("h2", {}, ["Entrar (Supabase)"]),
          el("p", {}, ["Login por email/senha. Depois o app carrega seu perfil e dados."]),
          el("label", {}, ["Email"]),
          el("input", { id:"loginEmail", placeholder:"seuemail@dominio.com" }),
          el("label", {}, ["Senha"]),
          el("input", { id:"loginPass", type:"password", placeholder:"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" }),
          el("div", { class:"actions" }, [
            el("button", { class:"btn ok", onclick: doLogin }, ["Fazer login"]),
            el("button", { class:"btn", onclick: () => $("#btnOpenConfig").click() }, ["Config"]),
          ]),
          el("div", { id:"loginStatus", class:"status" }, ["Aguardando login‚Ä¶"])
        ]),
        el("div", { class:"card" }, [
          el("h2", {}, ["Diagn√≥stico"]),
          el("p", {}, ["Aqui voc√™ confere se a URL/AnonKey est√£o OK."]),
          el("div", { class:"row" }, [
            el("div", {}, [
              el("div", { class:"tag" }, ["SUPABASE_URL"]),
              el("div", { class:"mono", style:"margin-top:6px; font-size:12px; overflow-wrap:anywhere" }, [state.sbUrl || "‚Äî"])
            ]),
            el("div", {}, [
              el("div", { class:"tag" }, ["ANON_KEY"]),
              el("div", { class:"mono", style:"margin-top:6px; font-size:12px; overflow-wrap:anywhere" }, [state.sbKey ? (state.sbKey.slice(0,20)+"‚Ä¶") : "‚Äî"])
            ]),
          ]),
          el("div", { class:"hr" }),
          el("div", { class:"muted", style:"font-size:13px; line-height:1.55" }, [
            "Se der erro de login: confirme o usu√°rio em Authentication ‚Üí Users.",
            el("br"),
            "Se logar e n√£o carregar dados: √© RLS/Pol√≠ticas ou colunas faltando (o app tenta corrigir automaticamente)."
          ])
        ]),
      ]);
    }

    async function doLogin(){
      const email = ($("#loginEmail").value || "").trim();
      const pass = $("#loginPass").value || "";
      const box = $("#loginStatus");
      box.className = "status";
      box.textContent = "Entrando‚Ä¶";
      try{
        await sbLogin(email, pass);
        $("#btnLogout").disabled = false;
        box.className = "status ok";
        box.textContent = "Login OK. Carregando dados‚Ä¶";
        await refreshAll();
        setView("dashboard");
      }catch(err){
        box.className = "status bad";
        box.textContent = "Erro: " + (err?.message || "falha no login");
      }
    }

    function metric(labelTxt, valueTxt, kind=""){
      const t = el("div", { class:"tag " + (kind||"") }, [labelTxt]);
      const v = el("div", { class:"mono", style:"margin-top:6px; font-size:13px; overflow-wrap:anywhere" }, [valueTxt]);
      return el("div", {}, [t, v]);
    }

    function checkItem(txt, ok){
      return el("div", { style:"display:flex; align-items:center; justify-content:space-between; gap:10px; margin:8px 0" }, [
        el("div", { class:"muted" }, [txt]),
        el("span", { class:"tag " + (ok ? "ok":"bad") }, [ok ? "OK" : "Pendente"])
      ]);
    }

    function viewDashboard(){
      const name = state.profile?.[COL.profiles.name] || "‚Äî";
      const cref = state.profile?.[COL.profiles.cref] || "‚Äî";
      const slogan = state.profile?.[COL.profiles.slogan] || "‚Äî";

      const students = state.cache.students || [];
      const sessions = state.cache.sessions || [];
      const exs = state.cache.exercises || [];

      const lastSession = sessions[0];
      const lastTitle = lastSession?.[COL.sessions.title] || "‚Äî";
      const lastDate = lastSession?.[COL.sessions.session_date] || lastSession?.[COL.sessions.created_at] || null;

      return el("div", { class:"grid" }, [
        el("div", { class:"card" }, [
          el("h2", {}, ["Dashboard"]),
          el("p", {}, ["Vis√£o geral do seu sistema."]),
          el("div", { class:"row" }, [
            metric("Profissional", name, "ok"),
            metric("CREF", cref, "warn"),
            metric("Slogan", slogan, ""),
          ]),
          el("div", { class:"hr" }),
          el("div", { class:"row" }, [
            metric("Alunos", String(students.length), "ok"),
            metric("Sess√µes", String(sessions.length), "ok"),
            metric("Exerc√≠cios", String(exs.length), "ok"),
          ]),
          el("div", { class:"hr" }),
          el("div", { class:"muted", style:"font-size:13px; line-height:1.55" }, [
            "√öltima sess√£o: ", el("span", { class:"mono" }, [lastTitle]),
            el("br"),
            "Data: ", el("span", { class:"mono" }, [fmtDateOnly(lastDate)])
          ]),
          el("div", { class:"actions" }, [
            el("button", { class:"btn ok", onclick: refreshAll }, [ state.loading ? "Atualizando‚Ä¶" : "Atualizar tudo" ]),
            el("button", { class:"btn", onclick: () => setView("alunos") }, ["Ir para Alunos"]),
            el("button", { class:"btn", onclick: () => setView("sessoes") }, ["Ir para Sess√µes"]),
          ]),
          state.loading ? el("div", { class:"status" }, ["Carregando‚Ä¶"]) : el("div", { class:"status ok" }, ["Sistema operacional."])
        ]),

        el("div", { class:"card" }, [
          el("h2", {}, ["Checklist t√©cnico (V1)"]),
          el("p", {}, ["Confirma√ß√£o do ‚Äúpadr√£o completo‚Äù antes de evoluir."]),
          checkItem("Auth (login/logout) funcionando", !!state.session?.user?.id),
          checkItem("profiles criado (id = uid)", !!state.profile),
          checkItem("students acess√≠vel (RLS ok)", Array.isArray(state.cache.students)),
          checkItem("sessions acess√≠vel (RLS ok)", Array.isArray(state.cache.sessions)),
          checkItem("exercises acess√≠vel (RLS ok)", Array.isArray(state.cache.exercises)),
          el("div", { class:"hr" }),
          el("div", { class:"muted", style:"font-size:12px; line-height:1.6" }, [
            "Se algum item falhar: √© RLS ou coluna faltando. O app tenta corrigir, mas se voc√™ mudar nomes no banco, ajuste em COL no topo do arquivo."
          ])
        ]),
      ]);
    }

    /* ===============================================================
       6) ALUNOS (students)
    =============================================================== */
    function viewAlunos(){
      return el("div", { class:"grid" }, [
        el("div", { class:"card" }, [
          el("h2", {}, ["Alunos"]),
          el("p", {}, ["Cadastre e gerencie seus alunos."]),
          el("div", { class:"actions" }, [
            el("button", { class:"btn ok", onclick: () => openStudentModal() }, ["+ Novo aluno"]),
            el("button", { class:"btn", onclick: loadStudentsThenRender }, ["Recarregar"]),
          ]),
          el("div", { class:"hr" }),
          renderStudentsTable(),
        ]),
        el("div", { class:"card" }, [
          el("h2", {}, ["Dica operacional"]),
          el("p", {}, ["Padr√£o simples e escal√°vel: aluno ‚Üí sess√µes ‚Üí itens da sess√£o (exerc√≠cios)."]),
          el("div", { class:"muted", style:"font-size:13px; line-height:1.55" }, [
            "‚Ä¢ Nome completo",
            el("br"),
            "‚Ä¢ Objetivo (ex.: Hipertrofia, Emagrecimento)",
            el("br"),
            "‚Ä¢ Observa√ß√µes (les√µes, restri√ß√µes)"
          ])
        ])
      ]);
    }

    async function loadStudentsThenRender(){
      state.loading = true; render();
      try{ await loadStudents(); }
      catch(e){ alert("Erro ao carregar alunos: " + e.message); }
      finally{ state.loading = false; render(); }
    }

    function renderStudentsTable(){
      const data = state.cache.students || [];
      if (!data.length){
        return el("div", { class:"status" }, ["Nenhum aluno ainda. Clique em ‚Äú+ Novo aluno‚Äù."]);
      }

      const table = el("table", {}, [
        el("thead", {}, [
          el("tr", {}, [
            el("th", {}, ["Nome"]),
            el("th", {}, ["Objetivo"]),
            el("th", {}, ["Criado"]),
            el("th", {}, ["A√ß√µes"]),
          ])
        ]),
        el("tbody", {}, data.map(row => {
          const name = row[COL.students.name] || "‚Äî";
          const goal = row[COL.students.goal] || "‚Äî";
          const created = fmtDateTime(row[COL.students.created_at]);
          return el("tr", {}, [
            el("td", {}, [name]),
            el("td", { class:"muted" }, [goal]),
            el("td", { class:"muted" }, [created]),
            el("td", { class:"tdActions" }, [
              el("button", { class:"btn small", onclick: () => openStudentModal(row) }, ["Editar"]),
              " ",
              el("button", { class:"btn small", onclick: () => setView("sessoes") }, ["Sess√µes"]),
              " ",
              el("button", { class:"btn small bad", onclick: () => deleteStudent(row) }, ["Excluir"]),
            ])
          ]);
        }))
      ]);

      return el("div", {}, [table]);
    }

    function openStudentModal(existing=null){
      const back = el("div", { class:"modalBackdrop", style:"display:flex" });
      const m = el("div", { class:"modal" });
      const isEdit = !!existing;

      const inName = el("input", { value: existing?.[COL.students.name] || "" });
      const inGoal = el("input", { value: existing?.[COL.students.goal] || "" });
      const inObs  = el("textarea", {}, [ existing?.[COL.students.notes] || "" ]);

      m.appendChild(el("div", { class:"modalHead" }, [
        el("h3", {}, [isEdit ? "Editar aluno" : "Novo aluno"]),
        el("button", { class:"close", onclick: () => back.remove() }, ["Fechar"])
      ]));

      m.appendChild(el("div", { class:"modalBody" }, [
        el("div", { class:"row" }, [
          el("div", {}, [ el("label", {}, ["Nome"]), inName ]),
          el("div", {}, [ el("label", {}, ["Objetivo"]), inGoal ]),
        ]),
        el("label", {}, ["Observa√ß√µes"]),
        inObs,
        el("div", { class:"actions" }, [
          el("button", { class:"btn ok", onclick: async () => {
            const payload = {
              [COL.students.name]: (inName.value || "").trim(),
              [COL.students.goal]: (inGoal.value || "").trim(),
              [COL.students.notes]: (inObs.value || "").trim(),
            };
            if (!payload[COL.students.name]) { alert("Preencha o nome."); return; }

            try{
              if (isEdit){
                await updateSmart(TABLES.students, `${COL.students.id}=eq.${encodeURIComponent(existing[COL.students.id])}`, payload);
              } else {
                await insertSmart(TABLES.students, payload);
              }
              await loadStudents();
              back.remove();
              render();
            }catch(e){
              alert("Erro ao salvar aluno: " + e.message);
            }
          }}, [isEdit ? "Salvar" : "Criar"]),
          el("button", { class:"btn", onclick: () => back.remove() }, ["Cancelar"])
        ])
      ]));

      back.appendChild(m);
      document.body.appendChild(back);
    }

    async function deleteStudent(row){
      if (!confirm("Excluir este aluno? (Sess√µes vinculadas n√£o s√£o apagadas automaticamente.)")) return;
      try{
        await sbDelete(TABLES.students, `${COL.students.id}=eq.${encodeURIComponent(row[COL.students.id])}`);
        await loadStudents();
        render();
      }catch(e){
        alert("Erro ao excluir: " + e.message);
      }
    }

    /* ===============================================================
       7) SESS√ïES (sessions)
    =============================================================== */
    function viewSessoes(){
      return el("div", { class:"grid" }, [
        el("div", { class:"card" }, [
          el("h2", {}, ["Sess√µes"]),
          el("p", {}, ["Crie sess√µes, vincule a um aluno e registre itens (exerc√≠cios)."]),
          el("div", { class:"actions" }, [
            el("button", { class:"btn ok", onclick: () => openSessionModal() }, ["+ Nova sess√£o"]),
            el("button", { class:"btn", onclick: loadSessionsThenRender }, ["Recarregar"]),
          ]),
          el("div", { class:"hr" }),
          renderSessionsTable(),
        ]),
        el("div", { class:"card" }, [
          el("h2", {}, ["Registrar itens (treino)"]),
          el("p", {}, ["Ap√≥s criar uma sess√£o, clique em ‚ÄúItens‚Äù para registrar exerc√≠cios."]),
          el("div", { class:"muted", style:"font-size:13px; line-height:1.55" }, [
            "Voc√™ ter√°:",
            el("br"),
            "‚Ä¢ S√©ries / Reps / Carga / RPE",
            el("br"),
            "‚Ä¢ M√©todo (ex.: Carga regressiva, Reps regressivas, Recupera√ß√£o regressiva)",
            el("br"),
            "‚Ä¢ Esquema (ex.: 12-10-8 / 60-70-80% / 90s-60s-45s)"
          ])
        ])
      ]);
    }

    async function loadSessionsThenRender(){
      state.loading = true; render();
      try{ await loadSessions(); }
      catch(e){ alert("Erro ao carregar sess√µes: " + e.message); }
      finally{ state.loading = false; render(); }
    }

    function renderSessionsTable(){
      const data = state.cache.sessions || [];
      if (!data.length){
        return el("div", { class:"status" }, ["Nenhuma sess√£o ainda. Clique em ‚Äú+ Nova sess√£o‚Äù."]);
      }

      const students = state.cache.students || [];
      const studentNameById = (id) => {
        const s = students.find(x => x[COL.students.id] === id);
        return s?.[COL.students.name] || "‚Äî";
      };

      const table = el("table", {}, [
        el("thead", {}, [
          el("tr", {}, [
            el("th", {}, ["Sess√£o"]),
            el("th", {}, ["Aluno"]),
            el("th", {}, ["Data"]),
            el("th", {}, ["Status"]),
            el("th", {}, ["A√ß√µes"]),
          ])
        ]),
        el("tbody", {}, data.map(row => {
          const title = row[COL.sessions.title] || "Sess√£o";
          const sid = row[COL.sessions.student_id] || null;
          const aluno = sid ? studentNameById(sid) : "‚Äî";
          const date = row[COL.sessions.session_date] || row[COL.sessions.created_at] || null;
          const status = String(row[COL.sessions.status] || "planejada").toLowerCase();

          const tagClass = status.includes("execut") ? "ok" : (status.includes("cancel") ? "bad" : "warn");

          return el("tr", {}, [
            el("td", {}, [title]),
            el("td", { class:"muted" }, [aluno]),
            el("td", { class:"muted" }, [fmtDateOnly(date)]),
            el("td", {}, [ el("span", { class:"tag "+tagClass }, [status]) ]),
            el("td", { class:"tdActions" }, [
              el("button", { class:"btn small", onclick: () => openSessionModal(row) }, ["Editar"]),
              " ",
              el("button", { class:"btn small", onclick: () => openItemsModal(row) }, ["Itens"]),
              " ",
              el("button", { class:"btn small bad", onclick: () => deleteSession(row) }, ["Excluir"]),
            ])
          ]);
        }))
      ]);

      return el("div", {}, [table]);
    }

    function openSessionModal(existing=null){
      const back = el("div", { class:"modalBackdrop", style:"display:flex" });
      const m = el("div", { class:"modal" });
      const isEdit = !!existing;

      const students = state.cache.students || [];
      const selStudent = el("select", {});
      selStudent.appendChild(el("option", { value:"" }, ["(sem aluno)"]));
      students.forEach(s => selStudent.appendChild(el("option", { value: s[COL.students.id] }, [s[COL.students.name] || "Aluno"])));

      const inTitle = el("input", { value: existing?.[COL.sessions.title] || "", placeholder:"Ex: For√ßa ‚Äî Superiores" });
      const inDate  = el("input", { type:"date" });
      const inStatus= el("select", {}, [
        el("option", { value:"planejada" }, ["planejada"]),
        el("option", { value:"executada" }, ["executada"]),
        el("option", { value:"cancelada" }, ["cancelada"]),
      ]);
      const inNotes = el("textarea", {}, [ existing?.[COL.sessions.notes] || "" ]);

      if (existing?.[COL.sessions.student_id]) selStudent.value = existing[COL.sessions.student_id];
      if (existing?.[COL.sessions.status]) inStatus.value = existing[COL.sessions.status];

      const existingDate = existing?.[COL.sessions.session_date];
      if (existingDate){
        // se vier ISO, corta
        inDate.value = String(existingDate).slice(0,10);
      }

      m.appendChild(el("div", { class:"modalHead" }, [
        el("h3", {}, [isEdit ? "Editar sess√£o" : "Nova sess√£o"]),
        el("button", { class:"close", onclick: () => back.remove() }, ["Fechar"])
      ]));

      m.appendChild(el("div", { class:"modalBody" }, [
        el("div", { class:"row" }, [
          el("div", {}, [ el("label", {}, ["T√≠tulo"]), inTitle ]),
          el("div", {}, [ el("label", {}, ["Aluno (opcional)"]), selStudent ]),
        ]),
        el("div", { class:"row" }, [
          el("div", {}, [ el("label", {}, ["Data (opcional)"]), inDate ]),
          el("div", {}, [ el("label", {}, ["Status"]), inStatus ]),
        ]),
        el("label", {}, ["Notas"]),
        inNotes,

        el("div", { class:"actions" }, [
          el("button", { class:"btn ok", onclick: async () => {
            const payload = {
              [COL.sessions.title]: (inTitle.value || "").trim() || "Sess√£o",
              [COL.sessions.status]: inStatus.value,
              [COL.sessions.notes]: (inNotes.value || "").trim(),
            };
            if (selStudent.value) payload[COL.sessions.student_id] = selStudent.value;
            if (inDate.value) payload[COL.sessions.session_date] = inDate.value; // date: YYYY-MM-DD

            try{
              if (isEdit){
                await updateSmart(TABLES.sessions, `${COL.sessions.id}=eq.${encodeURIComponent(existing[COL.sessions.id])}`, payload);
              } else {
                await insertSmart(TABLES.sessions, payload);
              }
              await loadSessions();
              back.remove();
              render();
            }catch(e){
              alert("Erro ao salvar sess√£o: " + e.message);
            }
          }}, [isEdit ? "Salvar" : "Criar"]),
          el("button", { class:"btn", onclick: () => back.remove() }, ["Cancelar"])
        ])
      ]));

      back.appendChild(m);
      document.body.appendChild(back);
    }

    async function deleteSession(row){
      if (!confirm("Excluir esta sess√£o?")) return;
      try{
        await sbDelete(TABLES.sessions, `${COL.sessions.id}=eq.${encodeURIComponent(row[COL.sessions.id])}`);
        await loadSessions();
        render();
      }catch(e){
        alert("Erro ao excluir sess√£o: " + e.message);
      }
    }

    /* ===============================================================
       8) ITENS DA SESS√ÉO (session_items)
       - Aqui entram os m√©todos regressivos
       - M√©todo e Esquema s√£o opcionais:
         * se o banco tiver colunas method/scheme, usamos.
         * se n√£o tiver, colocamos dentro de notes.
    =============================================================== */
    async function openItemsModal(sessionRow){
      const back = el("div", { class:"modalBackdrop", style:"display:flex" });
      const m = el("div", { class:"modal" });

      const title = sessionRow?.[COL.sessions.title] || "Sess√£o";
      const itemsBox = el("div", { class:"status" }, ["Carregando itens‚Ä¶"]);

      const exs = state.cache.exercises || [];
      const selEx = el("select", {});
      selEx.appendChild(el("option", { value:"" }, ["Selecione um exerc√≠cio"]));
      exs.forEach(ex => selEx.appendChild(el("option", { value: ex[COL.exercises.id] }, [ex[COL.exercises.name] || "Exerc√≠cio"])));

      const inSets = el("input", { placeholder:"S√©ries (ex: 4)" });
      const inReps = el("input", { placeholder:"Reps (ex: 8)" });
      const inLoad = el("input", { placeholder:"Carga (ex: 60)" });
      const inRpe  = el("input", { placeholder:"RPE (ex: 7)" });

      // ‚úÖ Campos de m√©todo/esquema (regressivos)
      const selMethod = el("select", {}, [
        el("option", { value:"" }, ["(m√©todo: nenhum)"]),
        el("option", { value:"carga_regressiva" }, ["Carga regressiva"]),
        el("option", { value:"reps_regressivas" }, ["Repeti√ß√µes regressivas"]),
        el("option", { value:"recuperacao_regressiva" }, ["Recupera√ß√£o regressiva"]),
        el("option", { value:"tradicional" }, ["Tradicional"]),
        el("option", { value:"outro" }, ["Outro"]),
      ]);

      const inScheme = el("input", {
        placeholder:"Esquema (ex.: 12-10-8 | 60-70-80% | 90s-60s-45s)"
      });

      const inNotes = el("input", { placeholder:"Notas (opcional)" });

      m.appendChild(el("div", { class:"modalHead" }, [
        el("h3", {}, ["Itens da sess√£o ‚Äî " + title]),
        el("button", { class:"close", onclick: () => back.remove() }, ["Fechar"])
      ]));

      m.appendChild(el("div", { class:"modalBody" }, [
        el("div", { class:"card", style:"padding:12px; margin-bottom:12px" }, [
          el("div", { class:"muted", style:"font-size:13px; margin-bottom:10px" }, ["Adicionar item (exerc√≠cio)"]),
          el("div", { class:"row" }, [
            el("div", {}, [ el("label", {}, ["Exerc√≠cio"]), selEx ]),
            el("div", {}, [ el("label", {}, ["S√©ries"]), inSets ]),
            el("div", {}, [ el("label", {}, ["Reps"]), inReps ]),
          ]),
          el("div", { class:"row" }, [
            el("div", {}, [ el("label", {}, ["Carga"]), inLoad ]),
            el("div", {}, [ el("label", {}, ["RPE"]), inRpe ]),
            el("div", {}, [ el("label", {}, ["Notas"]), inNotes ]),
          ]),
          el("div", { class:"row" }, [
            el("div", {}, [ el("label", {}, ["M√©todo de treino"]), selMethod ]),
            el("div", {}, [ el("label", {}, ["Esquema (regressivo / prescri√ß√£o)"]), inScheme ]),
          ]),
          el("div", { class:"actions" }, [
            el("button", { class:"btn ok", onclick: async () => {
              if (!selEx.value){ alert("Selecione um exerc√≠cio."); return; }

              const payload = {
                [COL.items.session_id]: sessionRow[COL.sessions.id],
                [COL.items.exercise_id]: selEx.value,
                [COL.items.sets]: toNum(inSets.value),
                [COL.items.reps]: toNum(inReps.value),
                [COL.items.load]: toNum(inLoad.value),
                [COL.items.rpe]:  toNum(inRpe.value),
              };

              // m√©todo/esquema: se o banco n√£o tiver colunas, o insertSmart vai remover
              if (selMethod.value) payload[COL.items.method] = selMethod.value;
              if ((inScheme.value || "").trim()) payload[COL.items.scheme] = (inScheme.value || "").trim();

              // notes sempre pode existir
              const baseNotes = (inNotes.value || "").trim();
              if (baseNotes) payload[COL.items.notes] = baseNotes;

              // Se o banco n√£o tiver method/scheme, garantimos que a info n√£o se perca:
              // (vai ser √∫til para PDF/treino depois)
              if ((selMethod.value || inScheme.value) && !payload[COL.items.notes]){
                payload[COL.items.notes] =
                  `M√©todo: ${selMethod.value || "‚Äî"} | Esquema: ${(inScheme.value || "").trim() || "‚Äî"}`;
              } else if ((selMethod.value || inScheme.value) && payload[COL.items.notes]){
                payload[COL.items.notes] =
                  payload[COL.items.notes] + ` | M√©todo: ${selMethod.value || "‚Äî"} | Esquema: ${(inScheme.value || "").trim() || "‚Äî"}`;
              }

              try{
                await insertSmart(TABLES.items, payload);

                // limpa
                inSets.value=""; inReps.value=""; inLoad.value=""; inRpe.value="";
                inNotes.value=""; inScheme.value=""; selMethod.value="";

                await loadSessionItems(sessionRow[COL.sessions.id], itemsBox);
              }catch(e){
                alert("Erro ao adicionar item: " + e.message);
              }
            }}, ["Adicionar item"]),
          ])
        ]),
        el("div", {}, [itemsBox])
      ]));

      back.appendChild(m);
      document.body.appendChild(back);

      await loadSessionItems(sessionRow[COL.sessions.id], itemsBox);
    }

    function toNum(v){
      const t = String(v||"").trim().replace(",",".");
      if (!t) return null;
      const n = Number(t);
      return Number.isFinite(n) ? n : null;
    }

    async function loadSessionItems(sessionId, container){
      container.className = "status";
      container.textContent = "Carregando itens‚Ä¶";

      try{
        const rows = await sbSelect(TABLES.items, `select=*&${COL.items.session_id}=eq.${encodeURIComponent(sessionId)}&order=created_at.asc`);

        if (!rows.length){
          container.className = "status";
          container.textContent = "Sem itens ainda. Adicione o primeiro exerc√≠cio acima.";
          return;
        }

        container.className = "";
        container.innerHTML = "";

        const exs = state.cache.exercises || [];
        const exName = (id) => exs.find(e => e[COL.exercises.id] === id)?.[COL.exercises.name] || "Exerc√≠cio";

        const table = el("table", {}, [
          el("thead", {}, [
            el("tr", {}, [
              el("th", {}, ["Exerc√≠cio"]),
              el("th", {}, ["S√©ries√óReps"]),
              el("th", {}, ["Carga"]),
              el("th", {}, ["RPE"]),
              el("th", {}, ["Notas / M√©todo"]),
              el("th", {}, ["A√ß√µes"]),
            ])
          ]),
          el("tbody", {}, rows.map(it => {
            const sets = it[COL.items.sets];
            const reps = it[COL.items.reps];
            const load = it[COL.items.load];
            const rpe  = it[COL.items.rpe];
            const notes= it[COL.items.notes] || "‚Äî";

            return el("tr", {}, [
              el("td", {}, [exName(it[COL.items.exercise_id])]),
              el("td", { class:"muted" }, [`${sets ?? "‚Äî"}√ó${reps ?? "‚Äî"}`]),
              el("td", { class:"muted" }, [load ?? "‚Äî"]),
              el("td", { class:"muted" }, [rpe ?? "‚Äî"]),
              el("td", { class:"muted" }, [notes]),
              el("td", { class:"tdActions" }, [
                el("button", { class:"btn small bad", onclick: async () => {
                  if (!confirm("Excluir este item?")) return;
                  try{
                    await sbDelete(TABLES.items, `${COL.items.id}=eq.${encodeURIComponent(it[COL.items.id])}`);
                    await loadSessionItems(sessionId, container);
                  }catch(e){
                    alert("Erro ao excluir item: " + e.message);
                  }
                }}, ["Excluir"])
              ])
            ]);
          }))
        ]);

        container.appendChild(table);

      }catch(e){
        container.className = "status bad";
        container.textContent = "Erro ao carregar itens: " + e.message;
      }
    }

    /* ===============================================================
       9) EXERC√çCIOS (exercises)
    =============================================================== */
    function viewExercicios(){
      return el("div", { class:"grid" }, [
        el("div", { class:"card" }, [
          el("h2", {}, ["Biblioteca de Exerc√≠cios"]),
          el("p", {}, ["Cadastre exerc√≠cios e use nas sess√µes."]),
          el("div", { class:"actions" }, [
            el("button", { class:"btn ok", onclick: () => openExerciseModal() }, ["+ Novo exerc√≠cio"]),
            el("button", { class:"btn", onclick: loadExercisesThenRender }, ["Recarregar"]),
          ]),
          el("div", { class:"hr" }),
          renderExercisesTable(),
        ]),
        el("div", { class:"card" }, [
          el("h2", {}, ["Seeds r√°pidos (opcional)"]),
          el("p", {}, ["Se voc√™ quiser, o Admin tem um bot√£o para inserir uma base inicial de exerc√≠cios."]),
          el("div", { class:"actions" }, [
            el("button", { class:"btn", onclick: () => setView("admin") }, ["Ir para Admin"])
          ])
        ])
      ]);
    }

    async function loadExercisesThenRender(){
      state.loading = true; render();
      try{ await loadExercises(); }
      catch(e){ alert("Erro ao carregar exerc√≠cios: " + e.message); }
      finally{ state.loading = false; render(); }
    }

    function renderExercisesTable(){
      const data = state.cache.exercises || [];
      if (!data.length){
        return el("div", { class:"status" }, ["Nenhum exerc√≠cio ainda. Clique em ‚Äú+ Novo exerc√≠cio‚Äù ou use Seeds no Admin."]);
      }

      const table = el("table", {}, [
        el("thead", {}, [
          el("tr", {}, [
            el("th", {}, ["Nome"]),
            el("th", {}, ["Grupo"]),
            el("th", {}, ["Criado"]),
            el("th", {}, ["A√ß√µes"]),
          ])
        ]),
        el("tbody", {}, data.map(row => {
          const name = row[COL.exercises.name] || "‚Äî";
          const group = row[COL.exercises.group_name] || "‚Äî";
          const created = fmtDateTime(row[COL.exercises.created_at]);
          return el("tr", {}, [
            el("td", {}, [name]),
            el("td", { class:"muted" }, [group]),
            el("td", { class:"muted" }, [created]),
            el("td", { class:"tdActions" }, [
              el("button", { class:"btn small", onclick: () => openExerciseModal(row) }, ["Editar"]),
              " ",
              el("button", { class:"btn small bad", onclick: () => deleteExercise(row) }, ["Excluir"]),
            ])
          ]);
        }))
      ]);

      return el("div", {}, [table]);
    }

    function openExerciseModal(existing=null){
      const back = el("div", { class:"modalBackdrop", style:"display:flex" });
      const m = el("div", { class:"modal" });
      const isEdit = !!existing;

      const inName = el("input", { value: existing?.[COL.exercises.name] || "", placeholder:"Ex: Agachamento livre" });
      const inGroup = el("input", { value: existing?.[COL.exercises.group_name] || "", placeholder:"Ex: Inferiores / Costas / Peito" });
      const inNotes = el("textarea", {}, [ existing?.[COL.exercises.notes] || "" ]);

      m.appendChild(el("div", { class:"modalHead" }, [
        el("h3", {}, [isEdit ? "Editar exerc√≠cio" : "Novo exerc√≠cio"]),
        el("button", { class:"close", onclick: () => back.remove() }, ["Fechar"])
      ]));

      m.appendChild(el("div", { class:"modalBody" }, [
        el("div", { class:"row" }, [
          el("div", {}, [ el("label", {}, ["Nome"]), inName ]),
          el("div", {}, [ el("label", {}, ["Grupo (group_name)"]), inGroup ]),
        ]),
        el("label", {}, ["Notas (opcional)"]),
        inNotes,
        el("div", { class:"actions" }, [
          el("button", { class:"btn ok", onclick: async () => {
            const payload = {
              [COL.exercises.name]: (inName.value || "").trim(),
              [COL.exercises.group_name]: (inGroup.value || "").trim(),
              [COL.exercises.notes]: (inNotes.value || "").trim(),
            };
            if (!payload[COL.exercises.name]) { alert("Preencha o nome do exerc√≠cio."); return; }

            try{
              if (isEdit){
                await updateSmart(TABLES.exercises, `${COL.exercises.id}=eq.${encodeURIComponent(existing[COL.exercises.id])}`, payload);
              } else {
                await insertSmart(TABLES.exercises, payload);
              }
              await loadExercises();
              back.remove();
              render();
            }catch(e){
              alert("Erro ao salvar exerc√≠cio: " + e.message);
            }
          }}, [isEdit ? "Salvar" : "Criar"]),
          el("button", { class:"btn", onclick: () => back.remove() }, ["Cancelar"])
        ])
      ]));

      back.appendChild(m);
      document.body.appendChild(back);
    }

    async function deleteExercise(row){
      if (!confirm("Excluir este exerc√≠cio? (Se ele estiver usado em session_items, pode dar erro)")) return;
      try{
        await sbDelete(TABLES.exercises, `${COL.exercises.id}=eq.${encodeURIComponent(row[COL.exercises.id])}`);
        await loadExercises();
        render();
      }catch(e){
        alert("Erro ao excluir: " + e.message);
      }
    }

    /* ===============================================================
       10) RELAT√ìRIOS (CSV simples)
    =============================================================== */
    function viewRelatorios(){
      return el("div", { class:"grid" }, [
        el("div", { class:"card" }, [
          el("h2", {}, ["Relat√≥rios"]),
          el("p", {}, ["Export simples (CSV) para alunos e sess√µes."]),
          el("div", { class:"actions" }, [
            el("button", { class:"btn ok", onclick: () => exportCsv("students", state.cache.students) }, ["Exportar alunos (CSV)"]),
            el("button", { class:"btn ok", onclick: () => exportCsv("sessions", state.cache.sessions) }, ["Exportar sess√µes (CSV)"]),
            el("button", { class:"btn", onclick: refreshAll }, ["Atualizar dados"]),
          ]),
          el("div", { class:"hr" }),
          el("div", { class:"muted", style:"font-size:13px; line-height:1.55" }, [
            "Pr√≥ximo upgrade (quando voc√™ pedir):",
            el("br"),
            "‚Ä¢ PDF por aluno (hist√≥rico + m√©todos regressivos por sess√£o).",
            el("br"),
            "‚Ä¢ Dashboard de carga (PSR/PSE/Strain/ACWR) integrado."
          ])
        ]),
        el("div", { class:"card" }, [
          el("h2", {}, ["Observa√ß√£o"]),
          el("p", {}, ["Este V1 √© simples e robusto em 1 arquivo. Evolu√ß√£o segura depende do schema ‚Äúcongelado‚Äù."]),
          el("div", { class:"status" }, ["Quando voc√™ confirmar o schema final, eu travo o padr√£o e evolu√≠mos sem retrabalho."])
        ])
      ]);
    }

    function exportCsv(name, rows){
      if (!rows || !rows.length){ alert("Sem dados para exportar."); return; }
      const cols = Object.keys(rows[0]);
      const esc = (v) => {
        if (v === null || v === undefined) return "";
        const s = String(v).replaceAll('"','""');
        return `"${s}"`;
      };
      const lines = [
        cols.join(","),
        ...rows.map(r => cols.map(c => esc(r[c])).join(","))
      ];
      const blob = new Blob([lines.join("\n")], { type:"text/csv;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `SPSV2_${name}_${new Date().toISOString().slice(0,10)}.csv`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    /* ===============================================================
       11) ADMIN
    =============================================================== */
    function viewAdmin(){
      return el("div", { class:"grid" }, [
        el("div", { class:"card" }, [
          el("h2", {}, ["Admin (padr√£o completo)"]),
          el("p", {}, ["A√ß√µes de manuten√ß√£o, seeds e diagn√≥stico."]),
          el("div", { class:"actions" }, [
            el("button", { class:"btn", onclick: refreshAll }, ["Recarregar tudo"]),
            el("button", { class:"btn", onclick: () => $("#btnOpenConfig").click() }, ["Config Supabase"]),
          ]),
          el("div", { class:"hr" }),
          el("div", { class:"actions" }, [
            el("button", { class:"btn ok", onclick: seedExercises }, ["Seed: Exerc√≠cios b√°sicos"]),
            el("button", { class:"btn", onclick: ensureProfileExists }, ["Garantir perfil (profiles)"]),
            el("button", { class:"btn bad", onclick: () => alert("Em V1 n√£o apagamos em massa. Seguran√ßa primeiro.") }, ["A√ß√µes destrutivas (bloqueado)"]),
          ]),
          el("div", { class:"hr" }),
          el("div", { class:"status" }, ["Admin pronto. Use seeds apenas se voc√™ quiser acelerar a base."])
        ]),
        el("div", { class:"card" }, [
          el("h2", {}, ["Estado atual"]),
          el("p", {}, ["Resumo do que est√° no navegador agora."]),
          el("div", { class:"muted", style:"font-size:13px; line-height:1.55" }, [
            "UID: ", el("span", { class:"mono" }, [state.session?.user?.id || "‚Äî"]),
            el("br"),
            "Email: ", el("span", { class:"mono" }, [state.session?.email || "‚Äî"]),
            el("br"),
            "Perfil: ", el("span", { class:"mono" }, [state.profile ? "OK" : "‚Äî"]),
            el("br"),
            "Alunos: ", el("span", { class:"mono" }, [String(state.cache.students?.length || 0)]),
            el("br"),
            "Sess√µes: ", el("span", { class:"mono" }, [String(state.cache.sessions?.length || 0)]),
            el("br"),
            "Exerc√≠cios: ", el("span", { class:"mono" }, [String(state.cache.exercises?.length || 0)]),
          ])
        ])
      ]);
    }

    async function ensureProfileExists(){
      try{
        const uid = state.session?.user?.id;
        if (!uid) return;

        const rows = await sbSelect(TABLES.profiles, `select=*&${COL.profiles.id}=eq.${encodeURIComponent(uid)}&limit=1`);
        if (rows?.[0]){
          state.profile = rows[0];
          applyAvatarFromProfile();
          alert("Perfil j√° existe. OK.");
          render();
          return;
        }

        const payload = {
          [COL.profiles.id]: uid,
          [COL.profiles.name]: "Fabiano Samurai",
          [COL.profiles.cref]: "CREF1: 043866-G/RJ",
          [COL.profiles.slogan]: "Personal na palma da sua m√£o",
          [COL.profiles.avatar_url]: null,
          [COL.profiles.logo_url]: null,
        };

        await sbInsert(TABLES.profiles, payload);
        await loadProfile();
        alert("Perfil criado. OK.");
        render();
      }catch(e){
        alert("Erro ao garantir perfil: " + e.message);
      }
    }

    async function seedExercises(){
      try{
        const base = [
          { name:"Agachamento livre", group_name:"Inferiores" },
          { name:"Leg press", group_name:"Inferiores" },
          { name:"Cadeira extensora", group_name:"Inferiores" },
          { name:"Mesa flexora", group_name:"Inferiores" },
          { name:"Panturrilha em p√©", group_name:"Inferiores" },
          { name:"Supino reto", group_name:"Peito" },
          { name:"Remada baixa", group_name:"Costas" },
          { name:"Puxada alta", group_name:"Costas" },
          { name:"Desenvolvimento militar", group_name:"Ombros" },
          { name:"Eleva√ß√£o lateral", group_name:"Ombros" },
        ];

        let ok = 0;
        for (const ex of base){
          try{
            await insertSmart(TABLES.exercises, {
              [COL.exercises.name]: ex.name,
              [COL.exercises.group_name]: ex.group_name,
              [COL.exercises.notes]: ""
            });
            ok++;
          }catch(_){}
        }

        await loadExercises();
        alert(`Seed conclu√≠do. Inseridos: ${ok} (alguns podem j√° existir).`);
        render();
      }catch(e){
        alert("Erro no seed: " + e.message);
      }
    }

    /* ===============================================================
       12) BOOT
    =============================================================== */
    (function boot(){
      setEnvTag();
      syncBadge();
      render();

      // se voc√™ quiser ‚Äúpersistir‚Äù sess√£o depois, a gente implementa refresh_token.
      // por enquanto, V1 simples e seguro.
    })();
  </script>
</body>
</html>
